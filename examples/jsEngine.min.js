Object.prototype["import"]=function(t){var e;e=void 0;for(e in t)if(t.hasOwnProperty(e)){if(void 0===e)continue;this[e]=t[e]}},window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}());var nameSpace;nameSpace=function(name){var i,str;for(i=void 0,name=name.split("."),i=0;i<name.length;)str=name.slice(0,i+1).join("."),void 0===eval("window."+str)&&eval(str+" = {}"),i++};var ALIGNMENT_CENTER,ALIGNMENT_LEFT,ALIGNMENT_RIGHT,EASING_LINEAR,EASING_POWER_IN,EASING_POWER_IN_OUT,EASING_POWER_OUT,EASING_QUAD_IN,EASING_QUAD_IN_OUT,EASING_QUAD_OUT,EASING_SINUS_IN_OUT,KEY_ALT_LEFT,KEY_ALT_RIGHT,KEY_BACKSPACE,KEY_CAPSLOCK,KEY_CONTROL,KEY_DOWN,KEY_ENTER,KEY_ESCAPE,KEY_F1,KEY_F10,KEY_F11,KEY_F12,KEY_F2,KEY_F3,KEY_F4,KEY_F5,KEY_F6,KEY_F7,KEY_F8,KEY_F9,KEY_LEFT,KEY_RIGHT,KEY_SHIFT,KEY_SPACE,KEY_TAB,KEY_UP,MOUSE_1,MOUSE_10,MOUSE_2,MOUSE_3,MOUSE_4,MOUSE_5,MOUSE_6,MOUSE_7,MOUSE_8,MOUSE_9,MOUSE_ANY,MOUSE_TOUCH_ANY,OFFSET_BOTTOM_CENTER,OFFSET_BOTTOM_LEFT,OFFSET_BOTTOM_RIGHT,OFFSET_MIDDLE_CENTER,OFFSET_MIDDLE_LEFT,OFFSET_MIDDLE_RIGHT,OFFSET_TOP_CENTER,OFFSET_TOP_LEFT,OFFSET_TOP_RIGHT,SPEED_PIXELS_PER_FRAME,SPEED_PIXELS_PER_SECOND,TOUCH_1,TOUCH_10,TOUCH_2,TOUCH_3,TOUCH_4,TOUCH_5,TOUCH_6,TOUCH_7,TOUCH_8,TOUCH_9,TOUCH_ANY;KEY_LEFT=37,KEY_UP=38,KEY_RIGHT=39,KEY_DOWN=40,KEY_SPACE=32,KEY_BACKSPACE=8,KEY_TAB=9,KEY_ENTER=13,KEY_SHIFT=16,KEY_CONTROL=17,KEY_ALT_LEFT=18,KEY_CAPSLOCK=20,KEY_ESCAPE=27,KEY_ALT_RIGHT=0,KEY_F1=112,KEY_F2=113,KEY_F3=114,KEY_F4=115,KEY_F5=116,KEY_F6=117,KEY_F7=118,KEY_F8=119,KEY_F9=120,KEY_F10=121,KEY_F11=122,KEY_F12=123,MOUSE_ANY=0,MOUSE_1=1,MOUSE_2=2,MOUSE_3=3,MOUSE_4=4,MOUSE_5=5,MOUSE_6=6,MOUSE_7=7,MOUSE_8=8,MOUSE_9=9,MOUSE_10=10,TOUCH_ANY=20,TOUCH_1=21,TOUCH_2=22,TOUCH_3=23,TOUCH_4=24,TOUCH_5=25,TOUCH_6=26,TOUCH_7=27,TOUCH_8=28,TOUCH_9=29,TOUCH_10=30,MOUSE_TOUCH_ANY=100,SPEED_PIXELS_PER_SECOND=1,SPEED_PIXELS_PER_FRAME=2,OFFSET_TOP_LEFT="tl",OFFSET_TOP_CENTER="tc",OFFSET_TOP_RIGHT="tr",OFFSET_MIDDLE_LEFT="ml",OFFSET_MIDDLE_CENTER="mc",OFFSET_MIDDLE_RIGHT="mr",OFFSET_BOTTOM_LEFT="bl",OFFSET_BOTTOM_CENTER="bc",OFFSET_BOTTOM_RIGHT="br",ALIGNMENT_LEFT="left",ALIGNMENT_CENTER="center",ALIGNMENT_RIGHT="right",function(){var t,e,i,o;e=function(t,e,i){switch(e){case"left":return t.projectionRegion.animate({x:t.projectionRegion.x+engine.canvasResX},i);case"right":return t.projectionRegion.animate({x:t.projectionRegion.x-engine.canvasResX},i);case"top":return t.projectionRegion.animate({y:t.projectionRegion.y+engine.canvasResY},i);case"bottom":return t.projectionRegion.animate({y:t.projectionRegion.y-engine.canvasResY},i)}},t=function(t,e,i){switch(e){case"left":return t.projectionRegion.x-=engine.canvasResX,t.projectionRegion.animate({x:t.projectionRegion.x+engine.canvasResX},i);case"right":return t.projectionRegion.x+=engine.canvasResX,t.projectionRegion.animate({x:t.projectionRegion.x-engine.canvasResX},i);case"top":return t.projectionRegion.y-=engine.canvasResY,t.projectionRegion.animate({y:t.projectionRegion.y+engine.canvasResY},i);case"bottom":return t.projectionRegion.y+=engine.canvasResY,t.projectionRegion.animate({y:t.projectionRegion.y-engine.canvasResY},i)}},o=function(t,e,i){switch(e){case"left":return t.projectionRegion.animate({width:0,x:t.projectionRegion.x+engine.canvasResX},i);case"right":return t.projectionRegion.animate({width:0},i);case"top":return t.projectionRegion.animate({height:0,y:t.projectionRegion.y+engine.canvasResY},i);case"bottom":return t.projectionRegion.animate({height:0},i)}},i=function(t,e,i){var o,n;switch(n=void 0,o=void 0,e){case"left":return n=t.projectionRegion.width,t.projectionRegion.width=0,t.projectionRegion.animate({width:n},i);case"right":return n=t.projectionRegion.width,t.projectionRegion.width=0,t.projectionRegion.x+=engine.canvasResX,t.projectionRegion.animate({x:t.projectionRegion.x-engine.canvasResX,width:n},i);case"top":return o=t.projectionRegion.height,t.projectionRegion.height=0,t.projectionRegion.animate({height:o},i);case"bottom":return o=t.projectionRegion.height,t.projectionRegion.height=0,t.projectionRegion.y+=engine.canvasResY,t.projectionRegion.animate({y:t.projectionRegion.y-engine.canvasResY,height:o},i)}},window.ROOM_TRANSITION_NONE=function(t,e,i,o){var n,r;for(r=void 0,n=void 0,r=0;r<engine.cameras.length;)n=engine.cameras[r],n.room===t&&(n.room=e),r++;o()},window.ROOM_TRANSITION_SLIDE_SLIDE=function(i,o,n,r){var s,a,h,c,u;for(h=void 0,a=void 0,u=void 0,c=void 0,s=void 0,u=[],i.pause(),n=n||{},n.from=n.from||"right",s={easing:n.easing||"quadInOut",duration:n.duration||2e3,loop:engine.masterRoom.loops.eachFrame},h=0;h<engine.cameras.length;)a=engine.cameras[h],a.room===i&&(e(a,n.from,s),c=new Engine.Camera(a.captureRegion.copy(),a.projectionRegion.copy(),o),u.push(c)),h++;engine.cameras.push.apply(engine.cameras,u),u.forEach(function(e){t(e,n.from,s)}),engine.masterRoom.loops.eachFrame.schedule(i,function(){this.play(),engine.cameras=engine.cameras.filter(function(t){return-1!==u.indexOf(t)}),r()},s.duration)},window.ROOM_TRANSITION_SQUEEZE_SLIDE=function(e,i,n,r){var s,a,h,c,u;for(h=void 0,a=void 0,u=void 0,c=void 0,s=void 0,u=[],e.pause(),n=n||{},n.from=n.from||"right",s={easing:n.easing||"quadInOut",duration:n.duration||2e3,loop:engine.masterRoom.loops.eachFrame},h=0;h<engine.cameras.length;)a=engine.cameras[h],a.room===e&&(o(a,n.from,s),c=new Engine.Camera(a.captureRegion.copy(),a.projectionRegion.copy(),i),u.push(c)),h++;engine.cameras.push.apply(engine.cameras,u),u.forEach(function(e){t(e,n.from,s)}),engine.masterRoom.loops.eachFrame.schedule(e,function(){this.play(),engine.cameras=engine.cameras.filter(function(t){return-1!==u.indexOf(t)}),r()},s.duration)},window.ROOM_TRANSITION_SQUEEZE_SQUEEZE=function(t,e,n,r){var s,a,h,c,u;for(h=void 0,a=void 0,u=void 0,c=void 0,s=void 0,u=[],t.pause(),n=n||{},n.from=n.from||"right",s={easing:n.easing||"quadInOut",duration:n.duration||2e3,loop:engine.masterRoom.loops.eachFrame},h=0;h<engine.cameras.length;)a=engine.cameras[h],a.room===t&&(o(a,n.from,s),c=new Engine.Camera(a.captureRegion.copy(),a.projectionRegion.copy(),e),u.push(c)),h++;engine.cameras.push.apply(engine.cameras,u),u.forEach(function(t){i(t,n.from,s)}),engine.masterRoom.loops.eachFrame.schedule(t,function(){this.play(),engine.cameras=engine.cameras.filter(function(t){return-1!==u.indexOf(t)}),r()},s.duration)},window.ROOM_TRANSITION_SLIDE_SQUEEZE=function(t,o,n,r){var s,a,h,c,u;for(h=void 0,a=void 0,u=void 0,c=void 0,s=void 0,u=[],t.pause(),n=n||{},n.from=n.from||"right",s={easing:n.easing||"quadInOut",duration:n.duration||2e3,loop:engine.masterRoom.loops.eachFrame},h=0;h<engine.cameras.length;)a=engine.cameras[h],a.room===t&&(e(a,n.from,s),c=new Engine.Camera(a.captureRegion.copy(),a.projectionRegion.copy(),o),u.push(c)),h++;engine.cameras.push.apply(engine.cameras,u),u.forEach(function(t){i(t,n.from,s)}),engine.masterRoom.loops.eachFrame.schedule(t,function(){this.play(),engine.cameras=engine.cameras.filter(function(t){return-1!==u.indexOf(t)}),r()},s.duration)}}(),EASING_LINEAR=function(t,e,i,o){return t/=o,e+i*t},EASING_QUAD_IN=function(t,e,i,o){return t/=o,e+i*t*t},EASING_QUAD_OUT=function(t,e,i,o){return t/=o,e-i*t*(t-2)},EASING_QUAD_IN_OUT=function(t,e,i,o){return t=t/o*2,1>t?e+i*t*t/2:(t--,e+i*(1-t*(t-2))/2)},EASING_POWER_IN=function(t,e,i,o){var n;return t/=o,n=i/Math.abs(i),e+n*Math.pow(Math.abs(i),t)},EASING_POWER_OUT=function(t,e,i,o){var n;return t/=o,n=i/Math.abs(i),e+i-n*Math.pow(Math.abs(i),1-t)},EASING_POWER_IN_OUT=function(t,e,i,o){var n;return t=t/o*2,n=i/Math.abs(i),1>t?e+n*Math.pow(Math.abs(i),t)/2:(t--,e+i-n*Math.pow(Math.abs(i),1-t)/2)},EASING_SINUS_IN_OUT=function(t,e,i,o){return t/=o,e+i*(1+Math.cos(Math.PI*(1+t)))/2};var Engine;Engine=function(){function t(t){window.engine=this,this.options=t||{},this.load()}return t.prototype.load=function(){var e,i,o,n;i=void 0,e=void 0,o=void 0,n=void 0,this.host={hasTouch:"ontouchstart"in document,hasMouse:!1,browserEngine:"Unknown",device:"Unknown",supportedAudio:[]},navigator.userAgent.match(/Firefox/)?this.host.browserEngine="Gecko":navigator.userAgent.match(/AppleWebKit/)?(this.host.browserEngine="WebKit",navigator.userAgent.match(/iPad|iPhone/)?this.host.device="iDevice":navigator.userAgent.match(/Android/)&&(this.host.device="Android")):navigator.userAgent.match(/Trident/)&&(this.host.browserEngine="Trident"),e=["mp3","ogg","wav"],o=0;for(;o<e.length;)document.createElement("audio").canPlayType("audio/"+e[o])&&this.host.supportedAudio.push(e[o]),o++;switch(this.avoidSubPixelRendering=!0,this.preloadSounds=!0,this.host.device){case"iDevice":this.preloadSounds=!1}for(this.running=!1,this.canvasResX=800,this.canvasResY=600,this.enginePath="js/jsEngine",this.focusOnLoad=!0,this.themesPath="assets",this.drawBoundingBoxes=!1,this.drawMasks=!1,this.pauseOnBlur=!0,this.disableRightClick=!0,this.preventDefaultKeyboard=!1,this.arena=document.getElementById("arena"),this.autoResize=!0,this.autoResizeLimitToResolution=!0,this.cachedSoundCopies=5,this.loadText="jsEngine loading...",this.backgroundColor="#000",this.timeFactor=1,this.disableTouchScroll=!0,this.resetCursorOnEachFrame=!0,this.cameras=[],this.defaultCollisionResolution=6,this.redrawObjects=[],this.enableRedrawRegions=!1,this.disableWebGL=!1,this.soundsMuted=!1,this.musicMuted=!1,i=["arena","autoResize","autoResizeLimitToResolution","avoidSubPixelRendering","backgroundColor","cachedSoundCopies","canvasResX","canvasResY","defaultCollisionResolution","disableWebGL","disableRightClick","disableTouchScroll","drawBoundingBoxes","drawMasks","enableRedrawRegions","enginePath","focusOnLoad","gameClass","loadText","musicMuted","pauseOnBlur","preventDefaultKeyboard","resetCursorOnEachFrame","soundsMuted","themesPath"],o=0;o<i.length;)n=i[o],void 0!==this.options[n]&&(this[n]=this.options[n],delete this.options[n]),o++;if(!this.gameClass)throw new Error("Game class missing");this.arena.style.position="absolute",this.arena.style.backgroundColor="#000",this.arena.style.userSelect="none",this.arena.style.webkitUserSelect="none",this.arena.style.MozUserSelect="none",this.createCanvas(),this.initRenderer(),this.autoResize?(this.autoResize=!1,this.setAutoResize(!0)):(this.autoResize=!0,this.setAutoResize(!1)),this.disableTouchScroll&&(document.addEventListener("touchmove",function(t){t.preventDefault()},!1),document.addEventListener("touchstart",function(t){t.preventDefault()},!1)),this.loader=new t.Loader,this.defaultTheme=this.options.themes[0],this.loader.onthemesloaded=function(){engine.initialize()},this.loader.loadThemes(this.options.themes)},t.prototype.initialize=function(){var e;e=void 0,this.objectIndex={},this.frames=0,this.last=(new Date).getTime(),this.now=this.last,this.gameTime=0,this.currentId=0,this.fps=0,this.fpsCounter=0,this.drawTime=0,this.drawTimeCounter=0,this.drawCalls=0,this.roomList=[],this.masterRoom=new t.Room("master"),this.currentRoom=new t.Room("main"),this.defaultAnimationLoop=this.currentRoom.loops.eachFrame,this.defaultActivityLoop=this.currentRoom.loops.eachFrame,this.cameras.push(new t.Camera(new Math.Rectangle(0,0,this.canvasResX,this.canvasResY),new Math.Rectangle(0,0,this.canvasResX,this.canvasResY))),this.disableRightClick&&(this.arena.oncontextmenu=function(){return!1}),this.keyboard=new Input.Keyboard,this.pointer=new Input.Pointer,this.pauseOnBlur&&(window.addEventListener("blur",function(){engine.stopMainLoop()}),window.addEventListener("focus",function(){engine.startMainLoop()})),new this.gameClass,this.startMainLoop(),this.focusOnLoad&&window.focus(),this.onload&&this.onload()},t.prototype.createCanvas=function(){this.canvas=document.createElement("canvas"),this.canvas.style.display="block",this.canvas.width=this.canvasResX,this.canvas.height=this.canvasResY,this.arena.appendChild(this.canvas)},t.prototype.initRenderer=function(){this.renderer=this.disableWebGL||!this.canvas.getContext("webgl")&&!this.canvas.getContext("experimental-webgl")?new Renderer.Canvas(this.canvas):new Renderer.WebGL(this.canvas)},t.prototype.setAutoResize=function(t){t&&!this.autoResize?(this.autoResize=!0,this.autoResizeCanvas(),window.addEventListener("resize",engine.autoResizeCanvas,!1),window.addEventListener("load",engine.autoResizeCanvas,!1)):!t&&this.autoResize&&(this.autoResize=!1,window.removeEventListener("resize",engine.autoResizeCanvas,!1),window.removeEventListener("load",engine.autoResizeCanvas,!1),this.arena.style.top="50%",this.arena.style.left="50%",this.arena.style.marginLeft=-this.canvasResX/2+"px",this.arena.style.marginTop=-this.canvasResY/2+"px",this.canvas.style.width=this.canvasResX+"px",this.canvas.style.height=this.canvasResY+"px")},t.prototype.autoResizeCanvas=function(){var t,e,i,o;return this!==engine?void engine.autoResizeCanvas():(e=void 0,i=void 0,o=void 0,t=void 0,o=window.innerWidth/window.innerHeight,t=this.canvasResX/this.canvasResY,o>t?(e=window.innerHeight,i=this.canvasResX/this.canvasResY*e):(i=window.innerWidth,e=this.canvasResY/this.canvasResX*i),this.autoResizeLimitToResolution&&(i=Math.min(i,this.canvasResX),e=Math.min(e,this.canvasResY)),this.arena.style.top="50%",this.arena.style.left="50%",this.arena.style.marginTop=-e/2+"px",this.arena.style.marginLeft=-i/2+"px",this.canvas.style.height=e+"px",void(this.canvas.style.width=i+"px"))},t.prototype.convertSpeed=function(t,e,i){if(void 0===t)throw new Error("Missing argument: speed");if(t instanceof Math.Vector)return new Math.Vector(this.convertSpeed(t.x,e,i),this.convertSpeed(t.y,e,i));switch(e=void 0!==e?e:SPEED_PIXELS_PER_SECOND,i=void 0!==i?i:SPEED_PIXELS_PER_FRAME,e){case SPEED_PIXELS_PER_SECOND:t=t*this.gameTimeIncrease/1e3;break;case SPEED_PIXELS_PER_FRAME:}switch(i){case SPEED_PIXELS_PER_SECOND:return t=t/this.gameTimeIncrease*1e3;case SPEED_PIXELS_PER_FRAME:return t}},t.prototype.goToRoom=function(t,e,i){var o;if(this.changingRoom)return!1;if(void 0===t)throw new Error("Missing argument: room");if("string"==typeof t){if(t=this.roomList.filter(function(e){return e.name===t})[0],!t)throw new Error("Could not find a room with the specified name")}else if(-1===this.roomList.indexOf(t))throw new Error("Room is not on room list, has it been removed?");return e=e?e:ROOM_TRANSITION_NONE,o=this.currentRoom,engine.changingRoom=!0,e(o,t,i,function(){engine.changingRoom=!1,engine.currentRoom=t}),o},t.prototype.addRoom=function(t){if(void 0===t)throw new Error("Missing argument: room");if(-1!==this.roomList.indexOf(t))throw new Error("Room is already on room list, rooms are automatically added upon instantiation");this.roomList.push(t)},t.prototype.removeRoom=function(t){var e;if(void 0===t)throw new Error("Missing argument: room");if(e=void 0,"string"==typeof t&&(t=this.roomList.getElementByPropertyValue("name",t),!t))throw new Error("Could not find a room with the specified name");if(e=this.roomList.indexOf(t),-1===e)throw new Error("Room is not on room list, has it been removed?");if(t===this.masterRoom)throw new Error("Cannot remove master room");if(t===this.currentRoom)throw new Error("Cannot remove current room, remember to leave the room first, by entering another room (use engine.goToRoom)");this.roomList.splice(i,1)},t.prototype.setSoundsMuted=function(t){t=void 0!==t?t:!0,t&&loader.getAllSounds().forEach(function(t){t.stopAll()}),this.soundsMuted=t},t.prototype.setMusicMuted=function(t){t=void 0!==t?t:!0,t&&loader.getAllMusic().forEach(function(t){t.stop()}),this.musicMuted=t},t.prototype.setDefaultTheme=function(t,e){if(void 0===t)throw new Error("Missing argument: themeName");if(void 0===loader.themes[t])throw new Error("Trying to set nonexistent theme: "+t);e=void 0!==e?e:!1,this.defaultTheme=t,this.currentRoom.setTheme(void 0,e)},t.prototype.startMainLoop=function(){this.running||(this.now=(new Date).getTime(),this.running=!0,engine.mainLoop())},t.prototype.stopMainLoop=function(){this.running&&(this.running=!1)},t.prototype.mainLoop=function(){var t;this.running&&(t=void 0,this.last=this.now,this.now=(new Date).getTime(),this.timeIncrease=this.now-this.last,this.gameTimeIncrease=this.timeIncrease*this.timeFactor,this.gameTime+=this.gameTimeIncrease,this.frames++,this.resetCursorOnEachFrame&&this.pointer.resetCursor(),this.masterRoom.update(),this.currentRoom.update(),this.drawCalls=0,t=(new Date).getTime(),this.renderer.render(this.cameras),t=(new Date).getTime()-t,this.fpsMsCounter<1e3?(this.fpsCounter++,this.drawTimeCounter+=t,this.fpsMsCounter+=this.timeIncrease):(this.fps=this.fpsCounter,this.drawTime=this.drawTimeCounter/this.fpsCounter,this.fpsCounter=0,this.drawTimeCounter=0,this.fpsMsCounter=0),requestAnimationFrame(function(t){engine.mainLoop(t)}))},t.prototype.setCanvasResX=function(t){this.canvas.width=t,this.canvasResX=t,this.autoResize&&this.autoResizeCanvas()},t.prototype.setCanvasResY=function(t){this.canvas.height=t,this.canvasResY=t,this.autoResize&&this.autoResizeCanvas()},t.prototype.registerObject=function(t,e){if(void 0===t)throw new Error("Missing argument: obj");if(void 0===e)this.currentId++,e="obj"+(this.currentId-1);else if(void 0!==this.objectIndex[e])throw new Error("Object id already taken: "+e);return this.objectIndex[e]=t,t.id=e,e},t.prototype.loadFileContent=function(t){var e;return e=new XMLHttpRequest,e.open("GET",t,!1),e.send(),e.responseText},t.prototype.loadFiles=function(t){var e,i,o;for(e=void 0,i=void 0,o=void 0,"string"==typeof t&&(t=[t]),e=0;e<t.length;)i=new XMLHttpRequest,i.open("GET",t[e],!1),i.send(),o=document.createElement("script"),o.type="text/javascript",o.text=i.responseText+"\n//# sourceURL=/"+t[e],document.body.appendChild(o),e++;void 0===window.loadedFiles&&(window.loadedFiles=[]),window.loadedFiles=window.loadedFiles.concat(t)},t.prototype.ajaxRequest=function(t,e,i,o,n){var r;if(void 0===t)throw new Error("Missing argument: url");if(void 0===o)throw new Error("Missing argument: callback");if(e=void 0!==e?e:"",i=void 0!==i?i:!0,n=void 0!==n?n:window,"string"!=typeof e&&(e="data="+JSON.stringify(e)),r=void 0,r=new XMLHttpRequest,i&&(r.onreadystatechange=function(){4===r.readyState&&200===r.status&&o.call(n,r.responseText)}),r.open("POST",t,i),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.send(e),!i){if(4!==r.readyState||200!==r.status)throw new Error("XMLHttpRequest failed: "+t);o.call(n,r.responseText)}},t.prototype.purge=function(t){var e,i,o,n,r;if(e=void 0,o=void 0,i=void 0,r=void 0,n=void 0,void 0===t)throw new Error("Cannot purge object: "+t);if("string"==typeof t&&(t=this.objectIndex[t]),t.children)for(e=t.children.length;e--;)engine.purge(t.children[e]);for(r=0;r<this.roomList.length;){n=this.roomList[r];for(o in n.loops)n.loops.hasOwnProperty(o)&&(i=n.loops[o],i.detachFunctionsByCaller(t),i.unscheduleByCaller(t),i.removeAnimationsOfObject(t));r++}t.parent&&t.parent.removeChildren(t),delete this.objectIndex[t.id]},t.prototype.dumpScreen=function(){var t,e;e=void 0,t=void 0,e=this.canvas.toDataURL().replace(/image\/png/,"image/octet-stream"),t=document.createElement("a"),t.href=e,t.setAttribute("download","screendump.png"),document.body.appendChild(t),t.click(),document.body.removeChild(t,document.body)},t}(),nameSpace("Engine"),Engine.Loader=function(){function Loader(){this.images={},this.loaded={classes:[]},this.themes={External:{name:"External",inherit:[],music:{},sfx:{},images:{},masks:{},textures:{},resourcesCount:0,resourcesLoaded:0}},this.loadOverlay=document.createElement("div"),this.loadOverlay.setAttribute("style","border: 0;position: absolute;top: 0;left: 0;width: 100%;height: 100%;z-index: 100;opacity: 1;"),this.loadOverlay.id="loadOverlay",this.loadOverlay.innerHTML='<div id="loadOverlayText">'+engine.loadText+"</div>",engine.arena.appendChild(this.loadOverlay)}return Loader.prototype.hideOverlay=function(t){this.fadeCallback=t,this.fadeOpacity=1,this.fade=function(t){return function(){var e;e=t.loadOverlay,t.fadeOpacity=Math.max(0,t.fadeOpacity-.1),t.fadeOpacity=Math.floor(100*t.fadeOpacity)/100,e.style.opacity=t.fadeOpacity,0!==t.fadeOpacity?setTimeout(function(){t.fade()},30):(engine.arena.removeChild(t.loadOverlay),delete t.fade,t.fadeCallback&&t.fadeCallback(),delete t.fadeCallback)}}(this),this.fade()},Loader.prototype.getImage=function(t,e){if(void 0===t)throw new Error("Missing argument: resource");return e=void 0!==e?e:engine.defaultTheme,this.getResource(t,"images",e)},Loader.prototype.getSound=function(t,e){if(void 0===t)throw new Error("Missing argument: resource");return e=void 0!==e?e:engine.defaultTheme,this.getResource(t,"sfx",e)},Loader.prototype.getMusic=function(t,e){if(void 0===t)throw new Error("Missing argument: resource");return e=void 0!==e?e:engine.defaultTheme,this.getResource(t,"music",e)},Loader.prototype.getMask=function(t,e){var i;if(void 0===t)throw new Error("Missing argument: resource");return e=void 0!==e?e:engine.defaultTheme,i=void 0,i=this.getResource(t,"masks",e),i?i:(i=this.generateMask(t),this.themes[e].masks[t]=i,i)},Loader.prototype.getResource=function(t,e,i){var o,n,r;if(void 0===t)throw new Error("Missing argument: resource");if(void 0===e)throw new Error("Missing argument: typeString");if(void 0===i)throw new Error("Missing argument: themeName");if(r=void 0,n=void 0,o=void 0,-1!==t.indexOf("/")&&(t=t.replace(/\//g,".")),r=this.themes[i][e][t],void 0===r)for(o=0;o<this.themes[i].inherit.length&&(n=this.themes[i].inherit[o],!this.themes[n]||!(r=this.themes[n][e][t]));)o++;return void 0===r?!1:r},Loader.prototype.getImageSources=function(){var t,e,i,o,n,r;for(n=void 0,r=void 0,t=void 0,o=void 0,i=void 0,e=void 0,n=this.themes[engine.defaultTheme].images,r=[],t=[],o=function(e){var i,n;if(n=void 0,i=void 0,void 0!==e.src)n=t.join("."),-1===r.indexOf(n)&&r.push(n);else for(i in e)e.hasOwnProperty(i)&&(t.push(i),o(e[i]),t.pop())},o(n),e=0;e<this.themes[engine.defaultTheme].inherit.length;)i=this.themes[this.themes[engine.defaultTheme].inherit[e]],void 0!==i&&void 0!==i.images&&o(i.images),e++;return r},Loader.prototype.getAllSounds=function(){var t,e,i,o;t=void 0,o=void 0,i=void 0,e=void 0,t=[];for(o in this.themes)if(this.themes.hasOwnProperty(o)){i=this.themes[o];for(e in i.sfx)i.sfx.hasOwnProperty(e)&&t.push(i.sfx[e])}return t},Loader.prototype.getAllMusic=function(){var t,e,i,o;t=void 0,o=void 0,i=void 0,e=void 0,t=[];for(o in this.themes)if(this.themes.hasOwnProperty(o)){i=this.themes[o];for(e in i.music)i.music.hasOwnProperty(e)&&t.push(i.music[e])}return t},Loader.prototype.loadClasses=function(t){var e,i;if(void 0===t)throw new Error("Missing argument: paths");i=void 0,e=void 0;for(e in t)if(t.hasOwnProperty(e)){if(i=t[e].match(/(\w*)\.\w+$/)[1],window[i])continue;engine.loadFiles(t[e]),this.loaded.classes[i]=t[e]}return!0},Loader.prototype.reloadAllClasses=function(){var t;t=void 0;for(t in this.loaded.classes)this.loaded.classes.hasOwnProperty(t)&&engine.loadFiles(this.loaded.classes[t])},Loader.prototype.loadThemes=function(themeNames,callback){var codeString,i,name,req,theme,total;if(void 0===themeNames)throw new Error("Missing argument: themeNames");for(void 0!==callback&&(this.onthemesloaded=callback),name=void 0,req=void 0,i=void 0,total=void 0,theme=void 0,codeString=void 0,i=0;i<themeNames.length;)name=themeNames[i],this.themes[name]||(req=new XMLHttpRequest,req.open("GET",engine.themesPath+"/"+name+"/theme.js",!1),req.send(),404!==req.status&&(codeString=req.responseText+"\n//# sourceURL=/"+engine.themesPath+"/"+name+"/theme.js",eval("theme = "+codeString),theme.inherit.length&&this.loadThemes(theme.inherit),theme.inherit.push("External"),this.themes[name]=theme,theme.resourcesCount=0,theme.resourcesLoaded=0,theme.masks={},theme.textures={},this.loadResources(theme,theme.images,"images"),this.loadResources(theme,theme.sfx,"sfx"),this.loadResources(theme,theme.music,"music"),i++));total=0;for(i in this.themes)this.themes.hasOwnProperty(i)&&(total+=this.themes[i].resourcesCount);0===total&&this.onthemesloaded&&this.onthemesloaded()},Loader.prototype.loadResources=function(t,e,i){var o,n,r,s,a,h;if(void 0===t)throw new Error("Missing argument: theme");if(void 0===e)throw new Error("Missing argument: object");if(void 0===i)throw new Error("Missing argument: typeString");s=function(e){return function(i){i.target.hasAttribute("data-loaded")||(i.target.setAttribute("data-loaded","true"),t=e.themes[i.target.getAttribute("data-theme")],t.resourcesLoaded++,e.checkAllLoaded())}}(this);for(a in e)if(e.hasOwnProperty(a)){switch(i){case"images":h=new Image,o=e[a].match(/(png|jpg|jpeg|svg)/),o&&(o=o[0]),h.src=engine.themesPath+"/"+t.name+"/images/"+a.replace(/\./g,"/")+"."+o,r=e[a].match(/; *(\d+) *images?/),h.imageLength=r?parseInt(r[1],10):1,h.spacing=e[a].match(/; *bordered/)?1:0,t.images[a]=h,h.onload=s,t.resourcesCount++;break;case"sfx":for(o=!1,n=0;n<engine.host.supportedAudio.length;)-1!==e[a].search(engine.host.supportedAudio[n])&&(o=engine.host.supportedAudio[n]),n++;if(!o)continue;h=new Audio(engine.themesPath+"/"+t.name+"/sfx/"+a.replace(/\./g,"/")+"."+o),t.sfx[a]=new Sound.Effect(h),engine.preloadSounds&&(h.setAttribute("preload","auto"),h.addEventListener("canplaythrough",s,!1),t.resourcesCount++);break;case"music":for(o=!1,n=0;n<engine.host.supportedAudio.length;)-1!==e[a].search(engine.host.supportedAudio[n])&&(o=engine.host.supportedAudio[n]),n++;if(!o)throw new Error("Sound was not available in a supported format: "+t.name+"/sfx/"+a.replace(/\./g,"/"));h=new Audio(engine.themesPath+"/"+t.name+"/music/"+a.replace(/\./g,"/")+"."+o),t.music[a]=new Sound.Music(h),engine.preloadSounds&&(h.setAttribute("preload","auto"),h.addEventListener("canplaythrough",s,!1),t.resourcesCount++)}h.setAttribute("data-theme",t.name),h.setAttribute("data-resourceString",a.replace(/\./g,"/"))}},Loader.prototype.loadExternalResource=function(t,e,i,o,n){var r,s,a,h;if(void 0===t)throw new Error("Missing argument: resourceString");if(void 0===e)throw new Error("Missing argument: path");switch(o=o||"images",i=i||function(){},n=n||"",h=this.themes.External,o){case"images":a=new Image,a.src=e,s=n.match(RegExp(" *(\\d+) *images?")),a.imageLength=s?parseInt(s[1],10):1,a.spacing=n.match(/; *bordered/)?1:0,h.images[t]=a,a.onload=i,h.resourcesCount++;break;case"sfx":if(r=e.match(/[^\.]*$/)[0],-1===engine.host.supportedAudio.indexOf(r))throw new Error("Sound format is not supported:",r);a=new Audio(e),h.sfx[t]=new Sound.Effect(a),engine.preloadSounds&&(a.setAttribute("preload","auto"),a.addEventListener("canplaythrough",i,!1),h.resourcesCount++);break;case"music":if(r=e.match(/[^\.]*$/)[0],-1===engine.host.supportedAudio.indexOf(r))throw new Error("Sound format is not supported:",r);a=new Audio(e),h.music[t]=new Music(a),engine.preloadSounds&&(a.setAttribute("preload","auto"),a.addEventListener("canplaythrough",i,!1),h.resourcesCount++)}a.setAttribute("data-theme",h.name),a.setAttribute("data-resourceString",t)},Loader.prototype.generateMask=function(t,e){var i,o,n,r,s,a,h,c,u,d,p,l,f;if(void 0===t)throw new Error("Missing argument: resourceString");if(e=void 0!==e?e:255,a=void 0,n=void 0,r=void 0,i=void 0,s=void 0,c=void 0,u=void 0,p=void 0,o=void 0,h=void 0,d=void 0,l=void 0,f=void 0,a=loader.getImage(t),n=document.createElement("canvas"),n.width=a.width,n.height=a.height,n.imageLength=a.imageLength,r=n.getContext("2d"),a===!1)throw new Error("Trying to create mask for non-existing resource: "+t);for(r.drawImage(a,0,0,a.width,a.height),i=r.getImageData(0,0,n.width,n.height),s=i.data,c=s.length/4,p=i.height,o=0,h=i.width,d=0,u=0;c>u;){if(s[4*u+3]<e)s[4*u]=0,s[4*u+1]=0,s[4*u+2]=0,s[4*u+3]=0;else{for(s[4*u]=0,s[4*u+1]=0,s[4*u+2]=0,s[4*u+3]=255,f=Math.floor(u/i.width),l=u-f*i.width;l>=Math.floor(a.width/a.imageLength);)l-=Math.floor(a.width/a.imageLength)+a.spacing;if(0>l)continue;p=Math.min(f,p),o=Math.max(f+1,o),h=Math.min(l,h),d=Math.max(l+1,d)}u++}return r.putImageData(i,0,0),n.bBox=new Math.Rectangle(h,p,d-h,o-p).getPolygon(),n},Loader.prototype.checkAllLoaded=function(){var t,e,i,o;t=void 0,o=void 0,e=void 0,i=void 0,o=0,e=0;for(t in this.themes)this.themes.hasOwnProperty(t)&&(i=this.themes[t],o+=i.resourcesCount,e+=i.resourcesLoaded);return e===o?(this.onthemesloaded&&this.onthemesloaded(),!0):!1},Loader}();var __slice=[].slice;nameSpace("Engine"),Engine.ObjectCreator=function(){function t(t){this.container=t}return t.prototype.Container=function(){var t,e,i;return e=1<=arguments.length?__slice.call(arguments,0):[],t=arguments,i=new View.Container,i.addChildren.apply(i,e),this.container.addChildren(i),i},t.prototype.Circle=function(t,e,i,o,n,r){var s;return s=new View.Circle(t,e,i,o,n,r),this.container.addChildren(s),s},t.prototype.Line=function(t,e,i,o,n){var r;return r=new View.Line(t,e,i,o,n),this.container.addChildren(r),r},t.prototype.Polygon=function(t,e,i,o){var n;return n=new View.Polygon(t,e,i,o),this.container.addChildren(n),n},t.prototype.Rectangle=function(t,e,i,o,n,r,s){var a;return a=new View.Rectangle(t,e,i,o,n,r,s),this.container.addChildren(a),a},t.prototype.TextBlock=function(t,e,i,o,n){var r;return r=new View.TextBlock(t,e,i,o,n),this.container.addChildren(r),r},t.prototype.Sprite=function(t,e,i,o,n){var r;return r=new View.Sprite(t,e,i,o,n),this.container.addChildren(r),r},t.prototype.Collidable=function(t,e,i,o,n){var r;return r=new View.Collidable(t,e,i,o,n),this.container.addChildren(r),r},t.prototype.GameObject=function(t,e,i,o,n){var r;return r=new View.GameObject(t,e,i,o,n),this.container.addChildren(r),r},t}(),nameSpace("Mixin"),Mixin.Animatable={animate:function(t,e){var i,o,n,r,s,a;if(void 0===t)throw new Error("Missing argument: properties");if(void 0===e)throw new Error("Missing argument: options");i={},s=t,a=e?e:{},i.obj=this,r=void 0!==e.loop?e.loop:void 0!==this.loop?this.loop:engine.defaultAnimationLoop,i.callback=void 0!==a.callback?a.callback:function(){},i.easing=void 0!==a.easing?a.easing:EASING_QUAD_IN_OUT,i.duration=void 0!==a.duration?a.duration:1e3,i.onStep=void 0!==a.onStep?a.onStep:function(){},i.prop={};for(n in s)s.hasOwnProperty(n)&&(i.prop[n]={begin:this[n],end:s[n]});o=0;for(n in i.prop)i.prop.hasOwnProperty(n)&&(i.prop[n].begin!==i.prop[n].end||this.propertyIsAnimated(n)?o++:delete i.prop[n]);(o||i.callback!==function(){})&&r.addAnimation(i)},isAnimated:function(){var t,e,i,o,n,r;for(r=void 0,n=void 0,o=void 0,i=void 0,t=void 0,e=void 0,r=0;r<engine.roomList.length;){n=engine.roomList[r];for(o in n.loops)if(n.loops.hasOwnProperty(o))for(i=n.loops[o],t=i.animations.length-1;t>-1;){if(e=i.animations[t],e.obj===this)return!0;t--}r++}return!1},propertyIsAnimated:function(t){var e,i,o,n,r,s;for(s=void 0,r=void 0,n=void 0,o=void 0,e=void 0,i=void 0,s=0;s<engine.roomList.length;){r=engine.roomList[s];for(n in r.loops)if(r.loops.hasOwnProperty(n))for(o=r.loops[n],e=o.animations.length-1;e>-1;){if(i=o.animations[e],i.obj===this&&void 0!==i.prop[t])return!0;e--}s++}return!1},getAnimations:function(){var t,e,i,o,n,r,s;for(i=void 0,s=void 0,r=void 0,n=void 0,o=void 0,t=void 0,e=void 0,i=[],s=0;s<engine.roomList.length;){r=engine.roomList[s];for(n in r.loops)if(r.loops.hasOwnProperty(n))for(o=r.loops[n],t=o.animations.length-1;t>-1;)e=o.animations[t],e.obj===this&&i.push(e),t--;s++}return i},stopAnimations:function(){var t,e,i;for(i=void 0,e=void 0,t=void 0,i=0;i<engine.roomList.length;){e=engine.roomList[i];for(t in e.loops)e.loops.hasOwnProperty(t)&&e.loops[t].removeAnimationsOfObject(this);i++}},schedule:function(t,e,i){var o;if(o=void 0,i=i||"eachFrame",o=this.getRoom(),!o)throw new Error("Schedule requires that the object is added to a room");o.loops[i].schedule(this,t,e)}},nameSpace("Mixin"),Mixin.MatrixCalculation={calculateLocalMatrix:function(t){var e,i,o;return o=void 0,i=void 0,e=void 0,o=this.makeScale(t.widthScale*t.size,t.heightScale*t.size),i=this.makeRotation(-t.direction),e=this.makeTranslation(t.x,t.y),this.matrixMultiplyArray([o,i,e])},calculateInverseLocalMatrix:function(t){var e,i,o;return o=void 0,i=void 0,e=void 0,o=this.makeScale(1/(t.widthScale*t.size),1/(t.heightScale*t.size)),i=this.makeRotation(t.direction),e=this.makeTranslation(-t.x,-t.y),this.matrixMultiplyArray([e,i,o])
},makeIdentity:function(){return[1,0,0,0,1,0,0,0,1]},makeTranslation:function(t,e){return[1,0,0,0,1,0,t,e,1]},makeRotation:function(t){var e,i;return e=Math.cos(t),i=Math.sin(t),[e,-i,0,i,e,0,0,0,1]},makeScale:function(t,e){return[t,0,0,0,e,0,0,0,1]},matrixDeterminant:function(t){var e,i,o,n,r,s,a,h,c;return e=t[0],i=t[1],o=t[2],n=t[3],r=t[4],s=t[5],a=t[6],h=t[7],c=t[8],e*(r*c-s*h)-i*(c*n-s*a)+o*(n*h-r*a)},matrixInverse:function(t){var e,i,o,n,r,s,a,h,c,u,d,p,l,f,g,m,y,v,w;return f=this.matrixDeterminant(t),0===f?!1:(u=t[0],d=t[1],p=t[2],l=t[3],g=t[4],m=t[5],y=t[6],v=t[7],w=t[8],e=g*w-m*v,i=-(l*w-m*y),o=l*v-g*y,n=-(d*w-p*v),r=u*w-p*y,s=-(u*v-d*y),a=d*m-p*g,h=-(u*m-p*l),c=u*g-d*l,this.matrixMultiplyNumber([e,n,a,i,r,h,o,s,c],1/f))},getNewMatrix:function(t){var e,i,o,n,r,s,a,h,c,u,d,p,l,f,g,m,y,v;return u=t[0],d=t[1],p=t[2],l=t[3],f=t[4],g=t[5],m=t[6],y=t[7],v=t[8],e=f*v-g*y,i=-(l*v-g*m),o=l*y-f*m,n=-(d*v-p*y),r=u*v-p*m,s=-(u*y-d*m),a=d*g-p*f,h=-(u*g-p*l),c=u*f-d*l,[e,n,a,i,r,h,o,s,c]},matrixMultiplyNumber:function(t,e){var i,o,n,r,s,a,h,c,u,d;return i=t[0],o=t[1],n=t[2],r=t[3],s=t[4],a=t[5],h=t[6],c=t[7],u=t[8],d=e,[i*d,o*d,n*d,r*d,s*d,a*d,h*d,c*d,u*d]},matrixMultiply:function(t,e){var i,o,n,r,s,a,h,c,u,d,p,l,f,g,m,y,v,w;return i=t[0],n=t[1],s=t[2],h=t[3],u=t[4],p=t[5],f=t[6],m=t[7],v=t[8],o=e[0],r=e[1],a=e[2],c=e[3],d=e[4],l=e[5],g=e[6],y=e[7],w=e[8],[i*o+n*c+s*g,i*r+n*d+s*y,i*a+n*l+s*w,h*o+u*c+p*g,h*r+u*d+p*y,h*a+u*l+p*w,f*o+m*c+v*g,f*r+m*d+v*y,f*a+m*l+v*w]},matrixMultiplyArray:function(t){var e,i,o;for(o=t[0],i=t.length,e=1;i>e;)o=this.matrixMultiply(o,t[e]),e++;return o}},nameSpace("Mixin"),Mixin.WebGLHelpers={colorFromCSSString:function(t){var e,i,o;return e=void 0,i=void 0,o=void 0,4===t.length?(e=t.substr(1,1),i=t.substr(2,1),o=t.substr(3,1),parseInt("0x"+e+e+i+i+o+o)):parseInt("0x"+t.substr(1,6))},setPlane:function(t,e,i,o,n){var r,s,a,h;r=e,s=e+o,a=i,h=i+n,t.bufferData(t.ARRAY_BUFFER,new Float32Array([r,a,s,a,r,h,r,h,s,a,s,h]),t.STATIC_DRAW)},setPlaneOutline:function(t,e,i,o,n,r){var s,a,h,c,u,d,p,l;r/=2,u=e-r,d=e+o+r,p=i-r,l=i+n+r,s=e+r,a=e+o-r,h=i+r,c=i+n-r,t.bufferData(t.ARRAY_BUFFER,new Float32Array([u,p,d,p,s,h,s,h,a,h,d,p,u,p,u,l,s,h,s,h,s,c,u,l,s,c,u,l,d,l,s,c,a,c,d,l,d,p,d,l,a,h,a,h,a,c,d,l]),t.STATIC_DRAW)},setConvexPolygon:function(t,e){t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.STATIC_DRAW)},setCircle:function(t,e,i,o,n){var r,s,a;for(s=void 0,r=void 0,a=void 0,r=new Array(2*o),a=2*Math.PI/o,s=0;o>s;)r[2*s]=e+Math.cos(a*s)*n,r[2*s+1]=i+Math.sin(a*s)*n,s++;t.bufferData(t.ARRAY_BUFFER,new Float32Array(r),t.STATIC_DRAW)},setCircleOutline:function(t,e,i,o,n,r){var s,a,h,c,u;for(s=new Array(4*o),u=2*Math.PI/o,c=n+r/2,h=n-r/2,a=0;o>=a;)s[4*a]=e+Math.cos(u*a)*c,s[4*a+1]=i+Math.sin(u*a)*c,s[4*a+2]=e+Math.cos(u*a)*h,s[4*a+3]=i+Math.sin(u*a)*h,a++;t.bufferData(t.ARRAY_BUFFER,new Float32Array(s),t.STATIC_DRAW)}},nameSpace("Renderer"),Renderer.WebGL=function(){function t(t){var e,i;this.canvas=t,this.cache={currentAlpha:void 0,currentResolution:{width:0,height:0}},this.programs={},this.currentProgram=!1,i={premultipliedAlpha:!1,alpha:!1},this.gl=t.getContext("webgl",i)||t.getContext("experimental-webgl",i),e=this.gl,e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND),this.programs={texture:new Renderer.WebGL.TextureShaderProgram(e),color:new Renderer.WebGL.ColorShaderProgram(e)}}return Object.prototype["import"].call(t.prototype,Mixin.MatrixCalculation),t.prototype.setProgram=function(t){var e;this.currentProgram!==t&&(e=void 0,e=this.gl,this.currentProgram=t,e.useProgram(t.program),t.onSet(e),e.uniform2f(t.locations.u_resolution,this.cache.currentResolution.width,this.cache.currentResolution.height),e.uniform1f(this.currentProgram.locations.u_alpha,this.cache.currentAlpha))},t.prototype.render=function(t){var e,i,o,n,r,s,a,h,c,u;for(o=this.gl,i=t.length,r=0;i>r;){for(e=t[r],c=e.captureRegion.width,n=e.captureRegion.height,(this.cache.currentResolution.width!==c||this.cache.currentResolution.height!==n)&&(this.cache.currentResolution.width=c,this.cache.currentResolution.height=n,this.currentProgram&&o.uniform2f(this.currentProgram.locations.u_resolution,c,n)),u=this.makeTranslation(-e.captureRegion.x,-e.captureRegion.y),o.viewport(e.projectionRegion.x,e.projectionRegion.y,e.projectionRegion.width,e.projectionRegion.height),a=[engine.masterRoom,e.room],h=a.length,s=0;h>s;)this.renderTree(a[s],u),s++;r++}},t.prototype.renderTree=function(t,e){var i,o,n,r,s;if(i=this.gl,r=this.matrixMultiplyArray([this.calculateLocalMatrix(t),e]),s=this.makeTranslation(-t.offset.x,-t.offset.y),t.isVisible()){switch(this.cache.currentAlpha!==t.opacity&&(this.cache.currentAlpha=t.opacity,this.currentProgram&&i.uniform1f(this.currentProgram.locations.u_alpha,t.opacity)),t.renderType){case"textblock":case"sprite":this.setProgram(this.programs.texture),this.currentProgram.renderSprite(i,t,this.matrixMultiply(s,r));break;case"line":this.setProgram(this.programs.color),this.currentProgram.renderLine(i,t,this.matrixMultiply(s,r));break;case"rectangle":this.setProgram(this.programs.color),this.currentProgram.renderRectangle(i,t,this.matrixMultiply(s,r));break;case"circle":this.setProgram(this.programs.color),this.currentProgram.renderCircle(i,t,this.matrixMultiply(s,r))}if(t.children)for(n=t.children.length,o=0;n>o;)this.renderTree(t.children[o],r),o++}},t}(),nameSpace("Renderer.WebGL"),Renderer.WebGL.TextureShaderProgram=function(){function t(t){var e,i,o,n;i=void 0,e=void 0,n=void 0,o=void 0,this.cache={regularTextCoordBuffer:!1,animatedTextCoordBuffer:!1,rectangleCornerBuffer:!1,currentBuffer:!1,currentTexture:void 0,textures:{}},this.program=t.createProgram(),this.initShaders(t),this.bindLocations(t),this.initBuffers(t)}return Object.prototype["import"].call(t.prototype,Mixin.WebGLHelpers),t.prototype.initShaders=function(t){var e,i,o,n;o=void 0,e=void 0,n=void 0,i=void 0,o="attribute vec2 a_position; attribute vec2 a_texCoord; uniform vec2 u_resolution; uniform mat3 u_matrix; varying vec2 v_texCoord; void main() { vec2 position = (u_matrix * vec3(a_position, 1)).xy; vec2 zeroToOne = position / u_resolution; vec2 zeroToTwo = zeroToOne * 2.0; vec2 clipSpace = zeroToTwo - 1.0; gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1); v_texCoord = a_texCoord; }",n=t.createShader(t.VERTEX_SHADER),t.shaderSource(n,o),t.compileShader(n),t.attachShader(this.program,n),e="precision mediump float; uniform sampler2D u_image; varying vec2 v_texCoord; uniform float u_alpha; void main() { vec4 textureColor = texture2D(u_image, v_texCoord); gl_FragColor = vec4(textureColor.rgb, textureColor.a * u_alpha); }",i=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(i,e),t.compileShader(i),t.attachShader(this.program,i),t.linkProgram(this.program)},t.prototype.bindLocations=function(t){this.locations={a_texCoord:t.getAttribLocation(this.program,"a_texCoord"),a_position:t.getAttribLocation(this.program,"a_position"),u_resolution:t.getUniformLocation(this.program,"u_resolution"),u_matrix:t.getUniformLocation(this.program,"u_matrix"),u_alpha:t.getUniformLocation(this.program,"u_alpha")}},t.prototype.initBuffers=function(t){this.cache.regularTextCoordBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.cache.regularTextCoordBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),t.STATIC_DRAW),this.cache.animatedTextCoordBuffer=t.createBuffer(),this.cache.rectangleCornerBuffer=t.createBuffer()},t.prototype.setRegularTextCoordBuffer=function(t){this.cache.currentBuffer!==this.cache.regularTextCoordBuffer&&(t.bindBuffer(t.ARRAY_BUFFER,this.cache.regularTextCoordBuffer),t.enableVertexAttribArray(this.locations.a_texCoord),t.vertexAttribPointer(this.locations.a_texCoord,2,t.FLOAT,!1,0,0),this.cache.currentBuffer=this.cache.regularTextCoordBuffer,t.bindBuffer(t.ARRAY_BUFFER,this.cache.rectangleCornerBuffer))},t.prototype.setAnimatedTextCoordBuffer=function(t,e){var i,o,n,r;i=(e.clipWidth+e.bm.spacing)*e.imageNumber,o=i+e.clipWidth,i/=e.bm.width,o/=e.bm.width,n=0,r=1,t.bindBuffer(t.ARRAY_BUFFER,this.cache.animatedTextCoordBuffer),t.bufferData(t.ARRAY_BUFFER,new Float32Array([i,n,o,n,i,r,i,r,o,n,o,r]),t.STATIC_DRAW),t.enableVertexAttribArray(this.locations.a_texCoord),t.vertexAttribPointer(this.locations.a_texCoord,2,t.FLOAT,!1,0,0),this.cache.currentBuffer=this.cache.animatedTextCoordBuffer,t.bindBuffer(t.ARRAY_BUFFER,this.cache.rectangleCornerBuffer)},t.prototype.onSet=function(t){t.bindBuffer(t.ARRAY_BUFFER,this.cache.rectangleCornerBuffer),t.enableVertexAttribArray(this.locations.a_position),t.vertexAttribPointer(this.locations.a_position,2,t.FLOAT,!1,0,0)},t.prototype.renderSprite=function(t,e,i){var o,n;o=this.locations,"textblock"===e.renderType&&this.cache.textures[e.bm.oldSrc]&&delete this.cache.textures[e.bm.oldSrc],n=this.getSpriteTexture(t,e),this.cache.currentTexture!==n&&(this.cache.currentTexture=n,1===e.imageLength?this.setRegularTextCoordBuffer(t):(engine.gameTime-e.animationLastSwitch>1e3/e.animationSpeed&&(e.imageNumber=e.imageNumber+(e.animationSpeed>0?1:-1),e.animationLastSwitch=engine.gameTime,e.imageNumber===e.imageLength?e.imageNumber=e.animationLoops?0:e.imageLength-1:-1===e.imageNumber&&(e.imageNumber=e.animationLoops?e.imageLength-1:0)),this.setAnimatedTextCoordBuffer(t,e)),t.bindTexture(t.TEXTURE_2D,n),this.setPlane(t,0,0,e.clipWidth,e.clipHeight)),t.uniformMatrix3fv(o.u_matrix,!1,i),t.drawArrays(t.TRIANGLES,0,6)},t.prototype.getSpriteTexture=function(t,e){return this.cache.textures[e.bm.src]||this.createSpriteTexture(t,e.bm)},t.prototype.createSpriteTexture=function(t,e){var i;return i=void 0,i=t.createTexture(),t.bindTexture(t.TEXTURE_2D,i),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),1===e.imageLength?t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR):t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.bindTexture(t.TEXTURE_2D,null),this.cache.textures[e.src]=i,i},t}(),nameSpace("Renderer.WebGL"),Renderer.WebGL.ColorShaderProgram=function(){function t(t){var e,i,o,n;i=void 0,e=void 0,n=void 0,o=void 0,this.program=t.createProgram(),this.initShaders(t),this.bindLocations(t),this.initBuffers(t),this.cache={currentBuffer:this.vertexBuffer}}return Object.prototype["import"].call(t.prototype,Mixin.WebGLHelpers),t.prototype.initShaders=function(t){var e,i,o,n;if(o=void 0,e=void 0,n=void 0,i=void 0,o="attribute vec2 a_position; uniform vec2 u_resolution; uniform mat3 u_matrix; void main() { vec2 position = (u_matrix * vec3(a_position, 1)).xy; vec2 zeroToOne = position / u_resolution; vec2 zeroToTwo = zeroToOne * 2.0; vec2 clipSpace = zeroToTwo - 1.0; gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1); }",n=t.createShader(t.VERTEX_SHADER),t.shaderSource(n,o),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(n));if(t.attachShader(this.program,n),e="precision mediump float; uniform int u_color; uniform float u_alpha; void main() { float rValue = float(u_color / 256 / 256); float gValue = float(u_color / 256 - int(rValue * 256.0)); float bValue = float(u_color - int(rValue * 256.0 * 256.0) - int(gValue * 256.0)); gl_FragColor = vec4(rValue / 255.0, gValue / 255.0, bValue / 255.0, u_alpha); }",i=t.createShader(t.FRAGMENT_SHADER),t.shaderSource(i,e),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(i));t.attachShader(this.program,i),t.linkProgram(this.program)},t.prototype.bindLocations=function(t){this.locations={a_position:t.getAttribLocation(this.program,"a_position"),u_resolution:t.getUniformLocation(this.program,"u_resolution"),u_matrix:t.getUniformLocation(this.program,"u_matrix"),u_color:t.getUniformLocation(this.program,"u_color"),u_alpha:t.getUniformLocation(this.program,"u_alpha")}},t.prototype.initBuffers=function(t){this.vertexBuffer=t.createBuffer()},t.prototype.onSet=function(t){t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.enableVertexAttribArray(this.locations.a_position),t.vertexAttribPointer(this.locations.a_position,2,t.FLOAT,!1,0,0)},t.prototype.renderLine=function(t,e,i){var o,n,r,s,a,h,c;h=void 0,c=void 0,a=void 0,s=void 0,o=void 0,n=void 0,r=void 0,h=this.locations,"transparent"!==e.strokeStyle&&(4===e.strokeStyle.length?(s=e.strokeStyle,o=s.substr(1,1),n=s.substr(2,1),r=s.substr(3,1),s=parseInt("0x"+o+o+n+n+r+r)):s=parseInt("0x"+e.strokeStyle.substr(1,6)),t.uniform1i(h.u_color,s),a=e.createPolygonFromWidth(e.lineWidth,e.lineCap).getCoordinates(),this.setConvexPolygon(t,a),t.uniformMatrix3fv(h.u_matrix,!1,i),t.drawArrays(t.TRIANGLE_FAN,0,a.length/2))},t.prototype.renderRectangle=function(t,e,i){var o;o=void 0,o=this.locations,t.uniformMatrix3fv(o.u_matrix,!1,i),"transparent"!==e.fillStyle&&(t.uniform1i(o.u_color,this.colorFromCSSString(e.fillStyle)),this.setPlane(t,0,0,e.width,e.height),t.drawArrays(t.TRIANGLES,0,6)),"transparent"!==e.strokeStyle&&(t.uniform1i(o.u_color,this.colorFromCSSString(e.strokeStyle)),this.setPlaneOutline(t,0,0,e.width,e.height,e.lineWidth),t.drawArrays(t.TRIANGLES,0,24))},t.prototype.renderCircle=function(t,e,i){var o,n,r;o=void 0,n=void 0,r=void 0,o=this.locations,t.uniformMatrix3fv(o.u_matrix,!1,i),r=e.radius<10?12:e.radius<50?30:e.radius<100?50:80,"transparent"!==e.fillStyle&&(t.uniform1i(o.u_color,this.colorFromCSSString(e.fillStyle)),this.setCircle(t,0,0,r,e.radius),t.drawArrays(t.TRIANGLE_FAN,0,r)),"transparent"!==e.strokeStyle&&(t.uniform1i(o.u_color,this.colorFromCSSString(e.strokeStyle)),this.setCircleOutline(t,0,0,r,e.radius,e.lineWidth),t.drawArrays(t.TRIANGLE_STRIP,0,2*r+2))},t}(),nameSpace("Renderer"),Renderer.Canvas=function(){function t(t){var e,i;e=void 0,i=void 0,this.canvas=t,this.context=t.getContext("2d")}return Object.prototype["import"].call(t.prototype,Mixin.MatrixCalculation),t.prototype.render=function(t){var e,i,o,n,r,s,a,h,c,u,d,p;for(o=t.length,e=this.context,e.clearRect(0,0,this.canvas.width,this.canvas.height),r=0;o>r;){for(i=t[r],e.save(),c=i.captureRegion.width,n=i.captureRegion.height,p=this.makeTranslation(-i.captureRegion.x,-i.captureRegion.y),d=0!==i.captureRegion.width&&0!==i.captureRegion.height?this.makeScale(i.projectionRegion.width/i.captureRegion.width,i.projectionRegion.height/i.captureRegion.height):this.makeIdentity(),u=this.matrixMultiply(p,d),u=this.matrixMultiply(u,this.makeTranslation(i.projectionRegion.x,i.projectionRegion.y)),e.beginPath(),e.moveTo(i.projectionRegion.x,i.projectionRegion.y),e.lineTo(i.projectionRegion.x+i.projectionRegion.width,i.projectionRegion.y),e.lineTo(i.projectionRegion.x+i.projectionRegion.width,i.projectionRegion.y+i.projectionRegion.height),e.lineTo(i.projectionRegion.x,i.projectionRegion.y+i.projectionRegion.height),e.closePath(),e.clip(),a=[engine.masterRoom,i.room],h=a.length,s=0;h>s;)this.renderTree(a[s],u),s++;e.restore(),r++}},t.prototype.renderTree=function(t,e){var i,o,n,r;if(n=this.matrixMultiplyArray([this.calculateLocalMatrix(t),e]),t.isVisible()){switch(""!==t.renderType&&(r=this.matrixMultiply(this.makeTranslation(-t.offset.x,-t.offset.y),n),this.context.setTransform(r[0],r[1],r[3],r[4],r[6],r[7]),this.context.globalAlpha=t.opacity),t.renderType){case"textblock":case"sprite":this.renderSprite(t);break;case"circle":this.renderCircle(t);break;case"line":this.renderLine(t);break;case"rectangle":this.renderRectangle(t);break;case"polygon":this.renderPolygon(t)}if(t.children)for(o=t.children.length,i=0;o>i;)this.renderTree(t.children[i],n),i++}},t.prototype.renderSprite=function(t){1!==t.imageLength&&0!==t.animationSpeed&&engine.gameTime-t.animationLastSwitch>1e3/t.animationSpeed&&(t.imageNumber=t.imageNumber+(t.animationSpeed>0?1:-1),t.animationLastSwitch=engine.gameTime,t.imageNumber===t.imageLength?t.imageNumber=t.animationLoops?0:t.imageLength-1:-1===t.imageNumber&&(t.imageNumber=t.animationLoops?t.imageLength-1:0)),this.context.drawImage(t.bm,(t.clipWidth+t.bm.spacing)*t.imageNumber,0,t.clipWidth,t.clipHeight,0,0,t.clipWidth,t.clipHeight)},t.prototype.renderCircle=function(t){var e;e=this.context,e.strokeStyle=t.strokeStyle,e.fillStyle=t.fillStyle,e.beginPath(),e.arc(0,0,t.radius,0,2*Math.PI,!0),e.lineWidth=t.lineWidth,e.globalAlpha=t.opacity,e.fill(),e.stroke()},t.prototype.renderPolygon=function(t){var e,i,o;for(e=this.context,e.strokeStyle=t.strokeStyle,e.fillStyle=t.fillStyle,t.lineDash!==[]&&e.setLineDash&&e.setLineDash(t.lineDash),e.beginPath(),o=t.points.length,i=0;o>i;)e.lineTo(t.points[i].x,t.points[i].y),i++;e.lineWidth=t.lineWidth,e.globalAlpha=t.opacity,t.closed?(e.closePath(),e.fill(),e.stroke()):(e.fill(),e.stroke(),e.closePath())},t.prototype.renderLine=function(t){var e;e=this.context,e.strokeStyle=t.strokeStyle,e.globalAlpha=t.opacity,e.beginPath(),e.moveTo(t.a.x,t.a.y),e.lineTo(t.b.x,t.b.y),e.lineWidth=t.lineWidth,e.lineCap=t.lineCap,e.stroke()},t.prototype.renderRectangle=function(t){var e;e=this.context,e.strokeStyle=t.strokeStyle,e.fillStyle=t.fillStyle,e.beginPath(),e.moveTo(0,0),e.lineTo(t.width,0),e.lineTo(t.width,t.height),e.lineTo(0,t.height),e.closePath(),e.lineWidth=t.lineWidth,e.fill(),e.stroke()},t}(),nameSpace("Math"),Math.Vector=function(){function t(t,e){this.set(t,e)}return Object.prototype["import"].call(t.prototype,Mixin.Animatable),t.prototype.set=function(t,e){return this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this},t.prototype.setFromDirection=function(t,e){if("number"!=typeof t)throw new Error("Argument direction should be of type: Number");if("number"!=typeof e)throw new Error("Argument length should be of type: Number");return this.x=Math.cos(t)*e,this.y=Math.sin(t)*e,this},t.prototype.copy=function(){return new Math.Vector(this.x,this.y)},t.prototype.move=function(t,e){if("number"!=typeof t)throw new Error("Argument x should be of type: Number");if("number"!=typeof e)throw new Error("Argument y should be of type: Number");return this.x+=t,this.y+=e,this},t.prototype.rotate=function(t){if("number"!=typeof t)throw new Error("Argument direction should be of type: Number");return this.setFromDirection(this.getDirection()+t,this.getLength()),this},t.prototype.scale=function(t,e){if("number"!=typeof t)throw new Error("Argument scaleH should be of type Number");return e=void 0!==e?e:t,this.x*=t,this.y*=e,this},t.prototype.add=function(t){if(t instanceof Math.Vector)this.x+=t.x,this.y+=t.y;else{if("number"!=typeof t)throw new Error("Argument vector should be of type Vector or Number");this.x+=t,this.y+=t}return this},t.prototype.subtract=function(t){if(t instanceof Math.Vector)this.x-=t.x,this.y-=t.y;else{if("number"!=typeof t)throw new Error("Argument vector should be of type Vector or Number");this.x-=t,this.y-=t}return this},t.prototype.divide=function(t){if(t instanceof Math.Vector)this.x/=t,this.y/=t;else{if("number"!=typeof t)throw new Error("Argument vector should be of type Vector or Number");this.x/=t,this.y/=t}return this},t.prototype.multiply=function(t){if(!t instanceof Math.Vector)throw new Error("Argument vector should be of type Vector");return this.x*=t.x,this.y*=t.y,this},t.prototype.getDot=function(t){if(!t instanceof Math.Vector)throw new Error("Argument vector should be of type: Vector");return this.x*t.x+this.y*t.y},t.prototype.getCross=function(t){if(!t instanceof Math.Vector)throw new Error("Argument vector should be of type: Vector");return this.x*t.y-this.y*t.x},t.prototype.getLength=function(){return Math.sqrt(this.getDot(this))},t.prototype.getDirection=function(){return Math.atan2(this.y,this.x)},t.prototype.getDirectionTo=function(t){if(!t instanceof Math.Vector)throw new Error("Only Vectors or objects inheriting Vector are supported");return t.copy().subtract(this).getDirection()},t.prototype.getDistance=function(t){if(t instanceof Math.Vector)return t.copy().subtract(this).getLength();if(t instanceof Math.Line)return t.getDistance(this);if(t instanceof Math.Circle)return t.getDistance(this);if(t instanceof Math.Rectangle)return t.getDistance(this);if(t instanceof Math.Polygon)return t.getDistance(this);throw new Error("Argument object should be of type: Vector, Line, Circle, Rectangle or Polygon")},t}(),nameSpace("Math"),Math.Line=function(){function t(t,e){t=void 0!==t?t:new Math.Vector,e=void 0!==e?e:new Math.Vector,this.setFromVectors(t,e)}return Object.prototype["import"].call(t.prototype,Mixin.Animatable),t.prototype.setFromVectors=function(t,e){if(!t instanceof Math.Vector)throw new Error("Argument startVector should be of type: Vector");if(!e instanceof Math.Vector)throw new Error("Argument endVector should be of type: Vector");return this.a=t,this.b=e,this},t.prototype.setFromCoordinates=function(t,e,i,o){return t=void 0!==t?t:0,e=void 0!==e?e:0,i=void 0!==i?i:0,o=void 0!==o?o:0,this.a=new Math.Vector(t,e),this.b=new Math.Vector(i,o),this},t.prototype.copy=function(){return new Math.Line(this.a,this.b)},t.prototype.move=function(t,e){return this.a.move(t,e),this.b.move(t,e),this},t.prototype.rotate=function(t){if("number"!=typeof t)throw new Error("Argument direction should be of type: Number");return this.a.rotate(t),this.b.rotate(t),this},t.prototype.scale=function(t,e){return this.a.scale(t,e),this.b.scale(t,e),this},t.prototype.add=function(t){return this.a.add(t),this.b.add(t),this},t.prototype.subtract=function(t){return this.a.substract(t),this.b.substract(t),this},t.prototype.divide=function(t){return this.a.divide(t),this.b.divide(t),this},t.prototype.multiply=function(t){return this.a.multiply(t),this.b.multiply(t),this},t.prototype.intersects=function(t){var e,i;if(t instanceof Math.Line){if(e=void 0,i=void 0,e=(this.b.x-this.a.x)*(t.a.y-this.b.y)-(t.a.x-this.b.x)*(this.b.y-this.a.y),i=(this.b.x-this.a.x)*(t.b.y-this.b.y)-(t.b.x-this.b.x)*(this.b.y-this.a.y),e*i>0)return!1;e=(t.b.x-t.a.x)*(this.a.y-t.b.y)-(this.a.x-t.b.x)*(t.b.y-t.a.y),i=(t.b.x-t.a.x)*(this.b.y-t.b.y)-(this.b.x-t.b.x)*(t.b.y-t.a.y)}else if(t instanceof Math.Circle)t.intersects(this);else if(t instanceof Math.Rectangle)t.getPolygon().intersects(this);else{if(!(t instanceof Math.Polygon))throw new Error("Argument object should be of type: Line, Rectangle, Circle or Polygon");t.intersects(this)}},t.prototype.getLength=function(){return this.b.copy().subtract(this.a).getLength()},t.prototype.getDistance=function(t){var e,i,o,n;if(o=void 0,e=void 0,n=void 0,i=void 0,t instanceof Math.Vector)o=this.a.copy().subtract(this.b),e=this.b.copy().subtract(this.a),n=t.copy().subtract(this.b),i=t.copy().subtract(this.a),e.getDot(n)>0?n.getLength():o.getDot(i)>0?i.getLength():Math.abs(e.getCross(i)/e.getLength());else if(t instanceof Math.Line)this.intersects(t)||Math.min(this.getDistance(t.a),this.getDistance(t.b),t.getDistance(this.a),t.getDistance(this.b));else if(t instanceof Math.Rectangle)t.getDistance(this);else{if(!(t instanceof Math.Circle))throw new Error("Argument object should be of type: Vector, Line, Circle, Rectangle or Polygon");t.getDistance(this)}},t.prototype.createPolygonFromWidth=function(t,e){var i,o,n,r,s,a,h,c,u,d,p,l;if(l=void 0,u=void 0,h=void 0,i=void 0,n=void 0,r=void 0,s=void 0,c=void 0,a=void 0,p=void 0,d=void 0,o=void 0,e=e||"butt",l=this.a.copy().subtract(this.b),l.set(l.y,-l.x),u=t/2/l.getLength(),h=l.scale(u),"round"!==e)return i=this.a.copy().add(h),n=this.a.copy().subtract(h),r=this.b.copy().subtract(h),s=this.b.copy().add(h),"square"===e&&(i.move(-h.y,h.x),n.move(-h.y,h.x),r.move(h.y,-h.x),s.move(h.y,-h.x)),new Math.Polygon([i,n,r,s]);for(c=new Array(32),p=h.getDirection(),t/=2,d=Math.PI/15,a=0;16>a;)o=p+d*a,c[a]=new Math.Vector(this.a.x+t*Math.cos(o),this.a.y+t*Math.sin(o)),a++;for(a=0;16>a;)o=p+d*(a+15),c[a+16]=new Math.Vector(this.b.x+t*Math.cos(o),this.b.y+t*Math.sin(o)),a++;return new Math.Polygon(c)},t.prototype.getPolygon=function(){return new Math.Polygon([this.a.copy(),this.b.copy()])},t}(),nameSpace("Math"),Math.Circle=function(){function t(t,e,i){this.set(t,e,i)}return Object.prototype["import"].call(t.prototype,Mixin.Animatable),t.prototype.set=function(t,e,i){return t=void 0!==t?t:0,e=void 0!==e?e:0,i=void 0!==i?i:0,this.x=t,this.y=e,this.radius=i,this},t.prototype.copy=function(){return new Math.Circle(this.x,this.y,this.radius)},t.prototype.move=function(t,e){if("number"!=typeof t)throw new Error("Argument x should be of type: Number");if("number"!=typeof e)throw new Error("Argument y should be of type: Number");return this.x+=t,this.y+=e,this},t.prototype.moveTo=function(t,e){if("number"!=typeof t)throw new Error("Argument x should be of type: Number");if("number"!=typeof e)throw new Error("Argument y should be of type: Number");return this.x=t,this.y=e,this},t.prototype.scale=function(t){if("number"!=typeof t)throw new Error("Argument factor should be of type Number");return this.radius*=t,this},t.prototype.getPerimeter=function(){return 2*this.radius*Math.PI},t.prototype.getArea=function(){return Math.pow(this.radius)*Math.PI},t.prototype.getDistance=function(t){if(t instanceof Math.Vector)Math.max(0,t.getDistance(new Math.Vector(this.x,this.y))-this.radius);else if(t instanceof Math.Line)Math.max(0,t.getDistance(new Math.Vector(this.x,this.y))-this.radius);else if(t instanceof Math.Circle)Math.max(0,new Math.Vector(this.x,this.y).getDistance(new Math.Vector(t.x,t.y))-(this.radius+t.radius));else if(t instanceof Math.Rectangle)t.getDistance(this);else{if(!(t instanceof Math.Polygon))throw new Error("Argument object should be of type: Vector, Line, Circle, Rectangle or Polygon");t.getDistance(this)}},t.prototype.contains=function(t){var e,i;if(i=void 0,e=void 0,t instanceof Math.Vector)t.copy().move(-this.x,-this.y).getLength()<this.radius;else if(t instanceof Math.Line)this.contains(t.a)&&this.contains(t.b);else if(t instanceof Math.Circle)e=new Math.Vector(t.x,t.y).move(-this.x,-this.y).getLength(),e+t.radius<this.radius;else if(t instanceof Math.Rectangle)this.contains(t.getPolygon());else{if(!(t instanceof Math.Polygon))throw new Error("Argument object has to be of type: Vector, Line, Circle, Rectangle or Polygon");for(i=0;i<t.points.length;){if(!this.contains(t.points[i]))return!1;i++}}},t.prototype.intersects=function(t){if(t instanceof Math.Line)this.contains(t)===!1&&t.getDistance(this)<=0;else if(t instanceof Math.Circle)!this.contains(t)&&!t.contains(this)&&new Math.Vector(this.x,this.y).getDistance(new Math.Vector(t.x,t.y))<=this.radius+t.radius;else if(t instanceof Math.Rectangle)t.getPolygon().intersects(this);else{if(!(t instanceof Math.Polygon))throw new Error("Argument object has to be of type: Line, Circle, Rectangle or Polygon");t.intersects(this)}},t}();var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};nameSpace("Math"),Math.Rectangle=function(t){function e(t,e,i,o){this.set(t,e,i,o)}return __extends(e,t),e.prototype.set=function(t,e,i,o){return this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.width=void 0!==i?i:0,this.height=void 0!==o?o:0,this},e.prototype.setFromVectors=function(t,e){return t=void 0!==t?t:new Math.Vector,e=void 0!==e?e:new Math.Vector,this.x=t.x,this.y=t.y,this.width=e.x,this.height=e.y,this},e.prototype.copy=function(){return new Math.Rectangle(this.x,this.y,this.width,this.height)},e.prototype.move=function(t,e){if("number"!=typeof t)throw new Error("Argument x should be of type: Number");if("number"!=typeof e)throw new Error("Argument y should be of type: Number");return this.x+=t,this.y+=e,this},e.prototype.moveTo=function(t,e){if("number"!=typeof t)throw new Error("Argument x should be of type: Number");if("number"!=typeof e)throw new Error("Argument y should be of type: Number");return this.x=t,this.y=e,this},e.prototype.getOverlap=function(t){var e,i,o,n,r;return n=void 0,r=void 0,i=void 0,o=void 0,e=void 0,n=this.x+this.width,r=this.y+this.height,i=t.x+t.width,o=t.y+t.height,e=new Math.Rectangle,e.x=t.x>this.x?t.x:this.x,e.y=t.y>this.y?t.y:this.y,n=i>n?n:i,r=o>r?r:o,e.width=n-e.x,e.height=r-e.y,e.width<=0||e.height<=0?!1:e},e.prototype.scale=function(t,e){if("number"!=typeof t)throw new Error("Argument scaleH should be of type Number");return e=void 0!==e?e:t,this.width*=t,this.height*=e,this},e.prototype.getBoundingRectangle=function(t){var e,i,o,n,r;return n=void 0,r=void 0,i=void 0,o=void 0,e=void 0,n=this.x+this.width,r=this.y+this.height,i=t.x+t.width,o=t.y+t.height,e=new Math.Rectangle,e.x=t.x<this.x?t.x:this.x,e.y=t.y<this.y?t.y:this.y,n=n>i?n:i,r=r>o?r:o,e.width=n-e.x,e.height=r-e.y,e},e.prototype.getPolygon=function(){return new Math.Polygon(this.getPoints())},e.prototype.getPoints=function(){return[new Math.Vector(this.x,this.y),new Math.Vector(this.x+this.width,this.y),new Math.Vector(this.x+this.width,this.y+this.height),new Math.Vector(this.x,this.y+this.height)]},e.prototype.getArea=function(){return this.width*this.height},e.prototype.getDiagonal=function(){return Math.sqrt(Math.pow(this.width,2)+Math.pow(this.height,2))},e.prototype.getDistance=function(t){return this.getPolygon().getDistance(t)},e.prototype.contains=function(t){return t instanceof Math.Rectangle?this.contains(new Math.Vector(t.x,t.y))&&this.contains(new Math.Vector(t.x+t.width,t.y+t.height)):t instanceof Math.Line?this.contains(t.a)&&this.contains(t.b):t instanceof Math.Vector?t.x>this.x&&t.x<this.x+this.width&&t.y>this.y&&t.y<this.y+this.height:this.getPolygon().contains(t)},e.prototype.intersects=function(t){return this.getPolygon().intersects(t)},e}(Math.Vector),nameSpace("Math"),Math.Polygon=function(){function t(t){this.setFromPoints(t)}return t.prototype.setFromPoints=function(t){return this.points=t,this},t.prototype.setFromCoordinates=function(){var t,e,i,o;for(e=Math.floor(arguments.length/2),this.points=[],t=0;e>t;){if(i=arguments[2*t],o=arguments[2*t+1],"number"!=typeof i||"number"!=typeof o)throw new Error("All arguments should be of type: Number");this.points.push(new Math.Vector(i,o)),t++}return this},t.prototype.getCoordinates=function(){var t,e,i;for(t=[],i=this.points.length,e=0;i>e;)t.push(this.points[e].x,this.points[e].y),e++;return t},t.prototype.move=function(t,e){if("number"!=typeof t)throw new Error("Argument x should be of type Number");if("number"!=typeof e)throw new Error("Argument y should be of type Number");return this.add(new Math.Vector(t,e))},t.prototype.add=function(t){var e;if(!t instanceof Math.Vector)throw new Error("Argument vector should be of type Vector");for(e=0;e<this.points.length;)this.points[e].add(t),e++;return this},t.prototype.rotate=function(t){var e;if("number"!=typeof t)throw new Error("Argument direction should be of type Number");for(e=0;e<this.points.length;)this.points[e].rotate(t),e++;return this},t.prototype.scale=function(t,e){var i;for(i=0;i<this.points.length;)this.points[i].scale(t,e),i++;return this},t.prototype.copy=function(){return new Math.Polygon(this.getPoints())},t.prototype.getPoints=function(){var t,e;for(e=[],t=0;t<this.points.length;)e.push(this.points[t].copy()),t++;return e},t.prototype.getLines=function(){var t,e,i,o;for(e=[],i=this.points,t=0;t<i.length;)o=t===i.length-1?0:t+1,e.push(new Math.Line(i[t],i[o])),t++;return e},t.prototype.getBoundingRectangle=function(){var t,e,i;if(0===this.points.length)throw new Error("Cannot create bounding rectangle for pointless polygon");for(i=new Math.Vector(this.points[0].x,this.points[0].y),t=i.copy(),e=0;e<this.points.length;)i.x=Math.min(this.points[e].x,i.x),i.y=Math.min(this.points[e].y,i.y),t.x=Math.max(this.points[e].x,t.x),t.y=Math.max(this.points[e].y,t.y),e++;return(new Math.Rectangle).setFromVectors(i,t.subtract(i))},t.prototype.getDistance=function(t){var e,i,o,n,r,s;if(e=Math.MAX_INTEGER,n=this.getLines(),t instanceof Math.Vector)for(i=0;i<n.length&&(e=Math.min(e,n[i].getDistance(t)),!(0>e));)i++;else if(t instanceof Math.Line)for(i=0;i<n.length&&(e=Math.min(e,n[i].getDistance(t)),!(0>e));)i++;
else if(t instanceof Math.Circle){for(s=new Math.Vector(t.x,t.y),i=0;i<n.length&&(e=Math.min(e,n[i].getDistance(s)),!(0>e));)i++;Math.max(0,e-t.radius)}else if(t instanceof Math.Rectangle)t.getDistance(this);else{if(!(t instanceof Math.Polygon))throw new Error("Argument object should be of type: Vector, Line, Circle, Rectangle or Polygon");for(r=t.getLines(),i=0;i<n.length;){for(o=0;o<r.length&&(e=Math.min(e,n[i].getDistance(r[o])),!(0>e));)o++;if(0>e)break;i++}}},t.prototype.contains=function(t){if(t instanceof Math.Vector)this.intersects((new Math.Line).setFromCoordinates(-123456,-98765,t.x,t.y),!0)%2;else if(t instanceof Math.Line)!this.intersects(t)&&this.contains(t.a);else if(t instanceof Math.Circle)this.contains(new Math.Vector(t.x,t.y))&&!this.intersects(t);else if(t instanceof Math.Rectangle)this.contains(t.getPolygon());else{if(!(t instanceof Math.Polygon))throw new Error("Argument object has to be of type: Vector, Line, Rectangle or Polygon");t.points.length>0&&!this.intersects(t)&&this.contains(t.points[0])}},t.prototype.intersects=function(t,e){var i,o,n,r,s,a,h;if(e=void 0!==e?e:!1,e&&(n=0),t instanceof Math.Line)for(s=this.getLines(),i=0;i<s.length;){if(r=s[i],r.intersects(t)){if(!e)return!0;n++}i++}else if(t instanceof Math.Circle)for(s=this.getLines(),i=0;i<s.length;){if(t.intersects(s[i])){if(!e)return!0;n++}i++}else{if(t instanceof Math.Rectangle)return this.intersects(t.getPolygon());if(!(t instanceof Math.Polygon))throw new Error("Argument object has to be of type: Line, Circle, Rectangle or Polygon");for(s=this.getLines(),h=t.getLines(),i=0;i<s.length;){for(r=s[i],o=0;o<h.length;){if(a=h[o],r.intersects(a)){if(!e)return!0;n++}o++}i++}}return e?n:!1},t}(),nameSpace("View"),View.Child=function(){function t(){this.renderType="",this.initWithoutRedrawRegions(),engine.registerObject(this)}return Object.prototype["import"].call(t.prototype,Mixin.Animatable),t.prototype.initWithoutRedrawRegions=function(){var t;this.x=0,this.y=0,this.opacity=1,this.direction=0,this.size=1,this.widthScale=1,this.heightScale=1,t={offset:new Math.Vector},Object.defineProperty(this,"offset",{get:function(){return t.offset},set:function(e){return"string"==typeof e?(this.offsetGlobal=e,t.offset=this.parseOffsetGlobal(e)):(this.offsetGlobal=!1,t.offset=e),e}})},t.prototype.initWithRedrawRegions=function(){var t;this.hasChanged=!1,t=void 0,t={x:0,y:0,opacity:1,direction:0,size:1,widthScale:1,heightScale:1,offset:void 0,parentObject:this},Object.defineProperty(this,"x",{get:function(){return t.x},set:function(e){t.x!==e&&(t.x=e,this.onAfterChange())}}),Object.defineProperty(this,"y",{get:function(){return t.y},set:function(e){t.y!==e&&(t.y=e,this.onAfterChange())}}),Object.defineProperty(this,"opacity",{get:function(){return t.opacity},set:function(e){t.opacity!==e&&(t.opacity=e,this.onAfterChange())}}),Object.defineProperty(this,"direction",{get:function(){return t.direction},set:function(e){t.direction!==e&&(t.direction=e,this.onAfterChange())}}),Object.defineProperty(this,"size",{get:function(){return t.size},set:function(e){t.size!==e&&(t.size=e,this.onAfterChange())}}),Object.defineProperty(this,"widthScale",{get:function(){return t.widthScale},set:function(e){t.widthScale!==e&&(t.widthScale=e,this.onAfterChange())}}),Object.defineProperty(this,"heightScale",{get:function(){return t.heightScale},set:function(e){t.heightScale!==e&&(t.heightScale=e,this.onAfterChange())}}),Object.defineProperty(this,"offset",{get:function(){return t.offset},set:function(e){var i;t.offset!==e&&(t.offset=e,i={x:e.x,y:e.y},Object.defineProperty(t.offset,"x",{get:function(){return i.x},set:function(e){i.x!==e&&(i.x=e,t.parentObject.onAfterChange())}}),Object.defineProperty(t.offset,"y",{get:function(){return i.y},set:function(e){i.y!==e&&(i.y=e,t.parentObject.onAfterChange())}}),this.onAfterChange())}}),this.offset=new Math.Vector},t.prototype.onAfterChange=function(){!this.hasChanged&&this.isDrawn()&&(this.lastRedrawRegion=this.currentRedrawRegion,this.currentRedrawRegion=this.getCombinedRedrawRegion?this.getCombinedRedrawRegion():this.getRedrawRegion(),this.currentRedrawRegion&&(engine.redrawObjects.push(this),this.hasChanged=!0))},t.prototype.parseOffsetGlobal=function(){return new Math.Vector},t.prototype.isInVisibleRoom=function(){var t;return t=void 0,t=this.getParents().pop(),t===engine.currentRoom||t===engine.masterRoom},t.prototype.isDrawn=function(){return this.isVisible()&&this.isInVisibleRoom()},t.prototype.getRoomPosition=function(){var t,e,i,o;if(o=void 0,i=void 0,e=void 0,t=void 0,i=this.getParents(),i.length&&i[i.length-1]instanceof Engine.Room){for(o=new Math.Vector(this.x,this.y),t=0;t<i.length;)e=i[t],o.scale(e.widthScale*e.size,e.heightScale*e.size),o.rotate(e.direction),o.move(e.x,e.y),t++;return o}return!1},t.prototype.getParents=function(){var t,e;for(t=void 0,e=void 0,e=[],t=this;void 0!==(t=t.parent);)e.push(t);return e},t.prototype.getRoom=function(){var t,e;return e=void 0,t=void 0,e=this.getParents(),0===e.length?!1:(t=e[e.length-1],t instanceof Engine.Room?t:!1)},t.prototype.moveTo=function(t,e){this.x=t||0,this.y=e||0},t.prototype.getDistanceTo=function(t){return this.getRoomPosition().subtract(t.getRoomPosition()).getLength()},t.prototype.getDirectionTo=function(t){return t.getRoomPosition().subtract(this.getRoomPosition()).getDirection()},t.prototype.isVisible=function(){return!(0===this.size||0===this.widthScale||0===this.heightScale)},t}();var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};nameSpace("View"),View.Line=function(t){function e(t,e,i,o,n){View.Child.call(this),this.renderType="line",engine.enableRedrawRegions?this.LineInitWithRedrawRegions(t,e,i,o,n):this.LineInitWithoutRedrawRegions(t,e,i,o,n)}return __extends(e,t),Object.prototype["import"].call(e.prototype,View.Child.prototype),e.prototype.LineInitWithoutRedrawRegions=function(t,e,i,o,n){this.strokeStyle=i||"#000",this.lineWidth=o||1,this.lineCap=n||"butt",this.setFromVectors(t||new Math.Vector,e||new Math.Vector)},e.prototype.LineInitWithRedrawRegions=function(t,e,i,o,n){var r;r=void 0,r={strokeStyle:i||"#000",lineWidth:o||1,lineCap:n||"butt",a:void 0,b:void 0,parentObject:this},Object.defineProperty(this,"strokeStyle",{get:function(){return r.strokeStyle},set:function(t){r.strokeStyle!==t&&(r.strokeStyle=t,this.onAfterChange())}}),Object.defineProperty(this,"lineCap",{get:function(){return r.lineCap},set:function(t){r.lineCap!==t&&(r.lineCap=t,this.onAfterChange())}}),Object.defineProperty(this,"lineWidth",{get:function(){return r.lineWidth},set:function(t){r.lineWidth!==t&&(r.lineWidth=t,this.onAfterChange())}}),Object.defineProperty(this,"a",{get:function(){return r.a},set:function(t){var e,i;r.a!==t&&(r.a=t,e=void 0,i=void 0,e=r.a.x,i=r.a.y,Object.defineProperty(r.a,"x",{get:function(){return e},set:function(t){e!==t&&(e=t,r.parentObject.onAfterChange())}}),Object.defineProperty(r.a,"y",{get:function(){return i},set:function(t){i!==t&&(i=t,r.parentObject.onAfterChange())}}),this.onAfterChange())}}),Object.defineProperty(this,"b",{get:function(){return r.b},set:function(t){var e,i;r.b!==t&&(r.b=t,e=void 0,i=void 0,e=r.b.x,i=r.b.y,Object.defineProperty(r.b,"x",{get:function(){return e},set:function(t){e!==t&&(e=t,r.parentObject.onAfterChange())}}),Object.defineProperty(r.b,"y",{get:function(){return i},set:function(t){i!==t&&(i=t,r.parentObject.onAfterChange())}}),this.onAfterChange())}}),this.setFromVectors(t||new Math.Vector,e||new Math.Vector)},e.prototype.getRedrawRegion=function(){var t,e,i,o,n;for(t=void 0,n=void 0,o=void 0,e=void 0,i=void 0,t=this.getPolygon(),n=this.getParents(),n.unshift(this),e=0;e<n.length;)o=n[e],t.scale(o.size*o.widthScale,o.size*o.heightScale),t.rotate(o.direction),t.move(o.x,o.y),e++;return t=t.getBoundingRectangle(),i=Math.ceil(this.lineWidth/2),t.x=Math.floor(t.x-i),t.y=Math.floor(t.y-i),t.width=Math.ceil(t.width+2*i+1),t.height=Math.ceil(t.height+2*i+1),t},e.prototype.isVisible=function(){return View.Child.prototype.isVisible.call(this)&&(this.a.x!==this.b.x||this.a.y!==this.b.y)},e}(Math.Line);var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};nameSpace("View"),View.Circle=function(t){function e(t,e,i,o,n,r){View.Child.call(this),this.renderType="circle",engine.enableRedrawRegions?this.CircleInitWithRedrawRegions(t,e,i,o,n,r):this.CircleInitWithoutRedrawRegions(t,e,i,o,n,r)}return __extends(e,t),Object.prototype["import"].call(e.prototype,View.Child.prototype),e.prototype.CircleInitWithoutRedrawRegions=function(t,e,i,o,n,r){this.radius=i,this.fillStyle=o||"#000",this.strokeStyle=n||"#000",this.lineWidth=r||1,this.set(t,e,i)},e.prototype.CircleInitWithRedrawRegions=function(t,e,i,o,n,r){var s;s=void 0,s={radius:i,fillStyle:o||"#000",strokeStyle:n||"#000",lineWidth:r||1},Object.defineProperty(this,"radius",{get:function(){return s.radius},set:function(t){s.radius!==t&&(s.radius=t,this.onAfterChange())}}),Object.defineProperty(this,"fillStyle",{get:function(){return s.fillStyle},set:function(t){s.fillStyle!==t&&(s.fillStyle=t,this.onAfterChange())}}),Object.defineProperty(this,"strokeStyle",{get:function(){return s.strokeStyle},set:function(t){s.strokeStyle!==t&&(s.strokeStyle=t,this.onAfterChange())}}),Object.defineProperty(this,"lineWidth",{get:function(){return s.lineWidth},set:function(t){s.lineWidth!==t&&(s.lineWidth=t,this.onAfterChange())}}),this.set(t,e,i)},e.prototype.getRedrawRegion=function(){var t,e;return e=void 0,t=void 0,t=Math.ceil(this.lineWidth/2),e=new Math.Rectangle(Math.floor(this.x-(this.radius+t+5)),Math.floor(this.y-(this.radius+t+5)),Math.ceil(2*(this.radius+t+5)),Math.ceil(2*(this.radius+t+5))),e.add(this.parent.getRoomPosition())},e}(Math.Circle);var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};nameSpace("View"),View.Rectangle=function(t){function e(t,e,i,o,n,r,s){View.Child.call(this),this.renderType="rectangle",engine.enableRedrawRegions?this.RectangleInitWithRedrawRegions(t,e,i,o,n,r,s):this.RectangleInitWithoutRedrawRegions(t,e,i,o,n,r,s)}return __extends(e,t),Object.prototype["import"].call(e.prototype,View.Child.prototype),e.prototype.RectangleInitWithoutRedrawRegions=function(t,e,i,o,n,r,s){var a;a=void 0,this.width=i||0,this.height=o||0,this.fillStyle=n||"#000",this.strokeStyle=r||"#000",a={lineWidth:s||1},Object.defineProperty(this,"lineWidth",{get:function(){return a.lineWidth},set:function(t){a.lineWidth!==t&&(a.lineWidth=t,this.offsetGlobal&&(this.offset=this.offsetGlobal))}}),this.set(t,e,i,o)},e.prototype.RectangleInitWithRedrawRegions=function(t,e,i,o,n,r,s){var a;a=void 0,a={width:i||0,height:o||0,fillStyle:n||"#000",strokeStyle:r||"#000",lineWidth:s||1},Object.defineProperty(this,"width",{get:function(){return a.width},set:function(t){a.width!==t&&(a.width=t,this.onAfterChange())}}),Object.defineProperty(this,"height",{get:function(){return a.height},set:function(t){a.height!==t&&(a.height=t,this.onAfterChange())}}),Object.defineProperty(this,"fillStyle",{get:function(){return a.fillStyle},set:function(t){a.fillStyle!==t&&(a.fillStyle=t,this.onAfterChange())}}),Object.defineProperty(this,"strokeStyle",{get:function(){return a.strokeStyle},set:function(t){a.strokeStyle!==t&&(a.strokeStyle=t,this.onAfterChange())}}),Object.defineProperty(this,"lineWidth",{get:function(){return a.lineWidth},set:function(t){a.lineWidth!==t&&(a.lineWidth=t,this.onAfterChange())}}),this.set(t,e,i,o)},e.prototype.parseOffsetGlobal=function(t){var e;return e=new Math.Vector,-1!==[OFFSET_TOP_LEFT,OFFSET_MIDDLE_LEFT,OFFSET_BOTTOM_LEFT].indexOf(t)?e.x=-this.lineWidth/2:-1!==[OFFSET_TOP_CENTER,OFFSET_MIDDLE_CENTER,OFFSET_BOTTOM_CENTER].indexOf(t)?e.x=this.width/2:-1!==[OFFSET_TOP_RIGHT,OFFSET_MIDDLE_RIGHT,OFFSET_BOTTOM_RIGHT].indexOf(t)&&(e.x=this.width+this.lineWidth/2),-1!==[OFFSET_TOP_LEFT,OFFSET_TOP_CENTER,OFFSET_TOP_RIGHT].indexOf(t)?e.y=-this.lineWidth/2:-1!==[OFFSET_MIDDLE_LEFT,OFFSET_MIDDLE_CENTER,OFFSET_MIDDLE_RIGHT].indexOf(t)?e.y=this.height/2:-1!==[OFFSET_BOTTOM_LEFT,OFFSET_BOTTOM_CENTER,OFFSET_BOTTOM_RIGHT].indexOf(t)&&(e.y=this.height+this.lineWidth/2),e},e.prototype.getRedrawRegion=function(){var t,e;return t=void 0,e=this.copy(),t=Math.ceil(this.lineWidth/2),e.x-=t,e.y-=t,e.width+=2*t,e.height+=2*t,e.add(this.parent.getRoomPosition())},e}(Math.Rectangle);var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};nameSpace("View"),View.Polygon=function(t){function e(t,e,i,o){View.Child.call(this),this.renderType="polygon",this.setFromPoints(t),this.fillStyle=e||"#000",this.strokeStyle=i||"#000",this.lineWidth=o||1,this.opacity=1,this.closed=1,this.lineDash=[]}return __extends(e,t),Object.prototype["import"].call(e.prototype,View.Child.prototype),e.prototype.getRedrawRegion=function(){var t,e;return t=void 0,e=this.getBoundingRectangle(),t=Math.ceil(this.lineWidth/2),e.x-=t,e.y-=t,e.width+=2*t,e.height+=2*t,e.add(this.parent.getRoomPosition())},e}(Math.Polygon);var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t},__slice=[].slice;nameSpace("View"),View.Container=function(t){function e(){var t;t=1<=arguments.length?__slice.call(arguments,0):[],this.children=[],e.__super__.constructor.call(this),this.parent=void 0,this.addChildren.apply(this,t),this.create=new Engine.ObjectCreator(this)}return __extends(e,t),e.prototype.addChildren=function(){var t,e;if(0!==arguments.length){for(e=0;e<arguments.length;){if(t=arguments[e],!t instanceof View.Child)throw new Error("Argument child has to be of type: View.Child");t.parent&&t.parent.removeChildren(t),this.children.push(t),t.parent=this,engine.enableRedrawRegions&&t.onAfterChange(),t.refreshSource&&t.refreshSource(),e++}return arguments}},e.prototype.insertBelow=function(t,e){var i,o;if(void 0===t)throw new Error("Missing argument: insertChildren");if(void 0===e)throw new Error("Missing argument: child");for(i=void 0,o=void 0,Array.prototype.isPrototypeOf(t)||(i=[],i.push(t),t=i),-1!==(o=this.children.indexOf(e))&&this.children.splice.apply(this.children,[o,0].concat(t)),o=0;o<t.length;){if(e=t[o],!e instanceof View.Child)throw new Error("Argument child has to be of type: Child");e.parent&&e.parent.removeChildren(e),e.parent=this,engine.enableRedrawRegions&&e.onAfterChange(),e.refreshSource&&e.refreshSource(),o++}return t},e.prototype.getChildren=function(){var t,e;for(e=void 0,t=void 0,e=[],t=0;t<this.children.length;)e.push(this.children[t]),t++;return e},e.prototype.setTheme=function(t,e){var i;if(t){if(void 0===loader.themes[t])throw new Error("Trying to set nonexistent theme: "+t)}else t=void 0;if(i=void 0,e=void 0!==e?e:!1,this.theme=t,this.refreshSource&&this.refreshSource(),e)for(i=0;i<this.children.length;)this.children[i].setTheme(void 0,!0),i++;else this.applyToThisAndChildren(function(){this.refreshSource&&this.refreshSource()})},e.prototype.applyToThisAndChildren=function(t){var e;if(void 0===t)throw new Error("Missing argument: function");for(e=void 0,t.call(this),e=0;e<this.children.length;)this.children[e].applyToThisAndChildren?this.children[e].applyToThisAndChildren(t):t.call(this.children[e]),e++},e.prototype.getCombinedRedrawRegion=function(){var t,e,i,o;for(e=void 0,t=void 0,o=void 0,i=void 0,this.getRedrawRegion&&(e=this.getRedrawRegion()),o=0;o<this.children.length;)i=this.children[o],t=i.getCombinedRedrawRegion?i.getCombinedRedrawRegion():i.getRedrawRegion(),i.currentRedrawRegion=t,t&&(e=e?e.getBoundingRectangle(t):t),o++;return e},e.prototype.removeChildren=function(){var t,e,i;if(0===arguments.length)throw new Error("This function needs at least one argument");for(e=void 0,t=void 0,i=void 0,i=[],e=arguments.length;e>-1;)t=this.children.indexOf(arguments[e]),-1!==t&&(this.children.splice(t,1),i.push(arguments[e]),arguments[e].parent=void 0),e--;return i},e.prototype.removeAllChildren=function(t){var e;t=void 0!==t?t:!0,e=void 0,e=this.children.splice(0,this.children.length),e.forEach(function(e){e.parent=void 0,t&&engine.purge(e)})},e.prototype.draw=function(t,e,i){engine.enableRedrawRegions?this.drawRedrawRegions(t,e):this.drawWholeCanvas(t,i)},e.prototype.drawWholeCanvas=function(t,e){var i,o,n;if(o=void 0,n=void 0,i=void 0,this.isVisible()){if(this.transformCanvasContext(t),this.drawCacheEnabled&&!e)t.drawImage(this.drawCacheCanvas,0,0);else for(this.drawCanvas&&(engine.drawCalls++,this.drawCanvas(t),engine.drawBoundingBoxes&&this.drawBoundingBox&&this.drawBoundingBox(t),engine.drawMasks&&this.drawMask&&this.drawMask(t)),n=this.children.length,o=0;n>o;)i=this.children[o],i.draw?i.draw(t):i.isVisible()&&(engine.drawCalls++,i.transformCanvasContext(t),i.drawCanvas(t),i.restoreCanvasContext(t)),o++;this.restoreCanvasContext(t)}},e.prototype.drawCanvas=void 0,e.prototype.getRedrawRegion=void 0,e}(View.Child);var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};nameSpace("View"),View.Sprite=function(t){function e(t,i,o,n,r){var s;if(void 0===t)throw new Error("Missing argument: source");if(e.__super__.constructor.call(this),this.renderType="sprite",this.x=void 0!==i?i:0,this.y=void 0!==o?o:0,this.source=t,this.direction=void 0!==n?n:0,this.imageNumber=0,this.imageLength=1,this.animationSpeed=30,this.animationLastSwitch=engine.gameTime,this.animationLoops=!0,this.clipWidth,this.clipHeight,Object.defineProperty(this,"width",{get:function(){return Math.abs(this.clipWidth*this.size*this.widthScale)},set:function(t){var e;return e=this.widthScale>0?1:-1,this.widthScale=e*Math.abs(t/(this.clipWidth*this.size)),t}}),Object.defineProperty(this,"height",{get:function(){return Math.abs(this.clipHeight*this.size*this.heightScale)},set:function(t){var e;return e=this.heightScale>0?1:-1,this.heightScale=e*Math.abs(t/(this.clipHeight*this.size)),t}}),s=OFFSET_MIDDLE_CENTER,r&&r.offset&&(s=r.offset,delete r.offset),this["import"](r),!this.refreshSource())throw new Error("Sprite source was not successfully loaded: "+t);this.offset=s,engine.avoidSubPixelRendering&&(this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y))}return __extends(e,t),Object.prototype["import"].call(e.prototype,Mixin.Animatable),e.prototype.parseOffsetGlobal=function(t){var e;return e=new Math.Vector,-1!==[OFFSET_TOP_LEFT,OFFSET_MIDDLE_LEFT,OFFSET_BOTTOM_LEFT].indexOf(t)?e.x=0:-1!==[OFFSET_TOP_CENTER,OFFSET_MIDDLE_CENTER,OFFSET_BOTTOM_CENTER].indexOf(t)?e.x=this.bm.width/this.imageLength/2:-1!==[OFFSET_TOP_RIGHT,OFFSET_MIDDLE_RIGHT,OFFSET_BOTTOM_RIGHT].indexOf(t)&&(e.x=this.bm.width/this.imageLength),-1!==[OFFSET_TOP_LEFT,OFFSET_TOP_CENTER,OFFSET_TOP_RIGHT].indexOf(t)?e.y=0:-1!==[OFFSET_MIDDLE_LEFT,OFFSET_MIDDLE_CENTER,OFFSET_MIDDLE_RIGHT].indexOf(t)?e.y=this.bm.height/2:-1!==[OFFSET_BOTTOM_LEFT,OFFSET_BOTTOM_CENTER,OFFSET_BOTTOM_RIGHT].indexOf(t)&&(e.y=this.bm.height),e},e.prototype.getTheme=function(){var t,e;for(t=void 0,e=void 0,e=this.theme,t=this;void 0===e;)if(t.theme)e=t.theme;else{if(!t.parent)break;t=t.parent}return e?e:engine.defaultTheme},e.prototype.refreshSource=function(){var t;return t=void 0,t=this.getTheme(),this.bm=engine.loader.getImage(this.source,t),this.imageLength=this.bm.imageLength,this.imageNumber=Math.min(this.imageLength-1,this.imageNumber),this.clipWidth=Math.floor(this.bm.width/this.imageLength),this.clipHeight=this.bm.height,this.offsetGlobal&&(this.offset=this.offsetGlobal),this.bm},e.prototype.setSource=function(t){if(void 0===t)throw new Error("Missing argument: source");this.source!==t&&(this.source=t,this.refreshSource())},e.prototype.getRedrawRegion=function(){var t,e,i,o;for(t=void 0,o=void 0,i=void 0,e=void 0,t=new Math.Rectangle(-this.offset.x,-this.offset.y,this.clipWidth,this.clipHeight).getPolygon(),o=this.getParents(),o.unshift(this),e=0;e<o.length;)i=o[e],t.scale(i.size*i.widthScale,i.size*i.heightScale),t.rotate(i.direction),t.move(i.x,i.y),e++;return t=t.getBoundingRectangle(),t.x=Math.floor(t.x),t.y=Math.floor(t.y),t.width=Math.ceil(t.width+1),t.height=Math.ceil(t.height+1),t},e}(View.Container);var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};nameSpace("View"),View.Collidable=function(t){function e(t,e,i,o,n){View.Sprite.call(this,t,e,i,o,n),this.mask=this.mask?this.mask:loader.getMask(t,this.getTheme()),this.collisionResolution=this.collisionResolution?this.collisionResolution:engine.defaultCollisionResolution}return __extends(e,t),e.prototype.boundingBoxCollidesWith=function(t,e){var i,o,n,r,s;if(void 0===t)throw new Error("Missing argument: objects");for(Array.prototype.isPrototypeOf(t)||(t=[t]),e=void 0!==e?e:!1,r=void 0,s=void 0,o=void 0,i=void 0,n=void 0,r=this.getTransformedBoundingBox(),i=[],o=0;o<t.length;){if(n=t[o],s=n.getTransformedBoundingBox(),r.intersects(s)||r.contains(s.points[0])||s.contains(r.points[0])){if(!e)return!0;i.push(n)}o++}return i.length?i:!1},e.prototype.getTransformedBoundingBox=function(){var t,e,i,o;for(t=void 0,o=void 0,i=void 0,e=void 0,t=this.mask.bBox.copy().move(-this.offset.x,-this.offset.y),o=this.getParents(),o.unshift(this),e=0;e<o.length;)i=o[e],(1!==i.size||1!==i.widthScale||1!==i.heightScale)&&t.scale(i.size*i.widthScale,i.size*i.heightScale),0!==i.direction&&t.rotate(i.direction),(0!==i.x||0!==i.y)&&t.move(i.x,i.y),e++;return t},e.prototype.maskCollidesWith=function(t,e){var i,o,n,r,s,a,h,c,u,d;if(void 0===t)throw new Error("Missing argument: objects");for(n=void 0,r=void 0,s=void 0,a=void 0,h=void 0,u=void 0,d=void 0,i=void 0,o=void 0,c=void 0,Array.prototype.isPrototypeOf(t)||(t=[t]),e=void 0!==e?e:!1,n=this.createCollisionBitmap(t),s=n.data.length/4,h=[],a=0;s>a;){if(u=a%n.width,this.collisionResolution>1&&u<this.collisionResolution&&(d=Math.floor(a/n.width),a-=u,d%2&&(a+=Math.floor(this.collisionResolution/2))),n.data[4*a]<127){if(!e)return!0;void 0===d&&(d=Math.floor(a/n.width)),h.push({x:u,y:d})}a+=this.collisionResolution}return h.length>0?(h=h.sort(function(t,e){return t.x===e.x?0:t.x>e.x?1:-1}),i=(h[0].x+h[h.length-1].x)/2,h=h.sort(function(t,e){return t.y===e.y?0:t.y>e.y?1:-1}),o=(h[0].y+h[h.length-1].y)/2,i-=this.offset.x,o-=this.offset.y,i/=this.size*this.widthScale,o/=this.size*this.heightScale,c=new Math.Vector(i,o),c.rotate(this.direction),c.pixelCount=h.length,c):!1},e.prototype.createCollisionBitmap=function(t){var e,i,o,n,r,s,a,h,c,u,d,p;for(c=void 0,o=void 0,h=void 0,e=void 0,d=void 0,r=void 0,s=void 0,p=void 0,a=void 0,n=void 0,i=void 0,u=void 0,h=this.mask,i=Mixin.MatrixCalculation,o=document.createElement("canvas"),o.width=Math.ceil(this.clipWidth),o.height=Math.ceil(this.clipHeight),e=o.getContext("2d"),e.fillStyle="#FFF",e.fillRect(0,0,o.width,o.height),d=this.getParents(),d.unshift(this),p=i.makeIdentity(),p=i.matrixMultiply(i.makeTranslation(this.offset.x,this.offset.y),p),r=0;r<d.length;)p=i.matrixMultiply(i.calculateInverseLocalMatrix(d[r]),p),r++;if(p===!1)throw new Error("Trying to detect collision for invisble object");for(r=0;r<t.length;)if(c=t[r],c!==this){for(a=i.makeIdentity(),d=c.getParents(),d.reverse(),d.push(c),s=0;s<d.length;)a=i.matrixMultiply(i.calculateLocalMatrix(d[s]),a),s++;u=i.matrixMultiply(a,p),u=i.matrixMultiply(i.makeTranslation(-c.offset.x,-c.offset.y),u),e.setTransform(u[0],u[1],u[3],u[4],u[6],u[7]),e.drawImage(c.mask,(c.clipWidth+c.bm.spacing)*c.imageNumber,0,c.clipWidth,c.clipHeight,0,0,c.clipWidth,c.clipHeight),r++}return e.setTransform(1,0,0,1,0,0),e.globalAlpha=.5,e.fillRect(0,0,o.width,o.height),e.drawImage(h,(this.clipWidth+this.bm.spacing)*this.imageNumber,0,this.clipWidth,this.clipHeight,0,0,this.clipWidth,this.clipHeight),e.getImageData(0,0,o.width,o.height)},e.prototype.collidesWith=function(t,e,i){var o,n,r;if(void 0===t)throw new Error("Missing argument: objects");if(r=void 0,o=void 0,n=void 0,Array.prototype.isPrototypeOf(t)||(t=[t]),i=void 0!==i?i:!1,0===this.size||0===this.widthScale||0===this.heightScale)return!1;if(t=this.boundingBoxCollidesWith(t,!0),t===!1)return!1;if(!e&&!i)return this.maskCollidesWith(t);if(r={objects:[],positions:[],combinedPosition:!1},i===!1)n=this.maskCollidesWith(t,!0),n&&(r.positions.push(n),r.combinedPosition=n.copy(),r.combinedPosition.pixelCount=0);else if(e){for(o=0;o<t.length;)n=this.maskCollidesWith(t[o],!0),n&&(r.objects.push(t[o]),r.positions.push(n)),o++;r.positions.length&&(r.combinedPosition=new Math.Vector,r.combinedPosition.pixelCount=0,r.positions.forEach(function(t){r.combinedPosition.add(t.scale(t.pixelCount)),r.combinedPosition.pixelCount+=t.pixelCount}),r.combinedPosition.scale(1/r.combinedPosition.pixelCount))}else for(o=0;o<t.length;)this.maskCollidesWith(t[o])&&r.objects.push(t[o]),o++;return r.positions.length+r.objects.length!==0?r:!1},e}(View.Sprite);var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};nameSpace("View"),View.TextBlock=function(t){function e(t,i,o,n,r){var s,a;if(void 0===t)throw new Error("Missing argument: string");e.__super__.constructor.call(this),this.renderType="textblock",this.x=void 0!==i?i:0,this.y=void 0!==o?o:0,this.imageLength=1,this.imageNumber=0,this.clipWidth=parseInt(n,10)||200,this.lines=[],this.lineWidth=[],this.bm=document.createElement("canvas"),this.bmCtx=this.bm.getContext("2d"),this.bm.width=this.clipWidth,this.bm.height=10,this.bm.spacing=0,s={string:"",font:"normal 14px Verdana",alignment:"left",color:"#000000",lineHeight:0},Object.defineProperty(this,"string",{get:function(){return s.string},set:function(t){return s.string="string"==typeof t?t:t.toString(),this.stringToLines(),this.cacheRendering(),engine.enableRedrawRegions&&this.onAfterChange(),t}}),Object.defineProperty(this,"font",{get:function(){return s.font},set:function(t){if("string"!=typeof t)throw new Error("font should be of type: string");return t===s.font?t:(s.font=t,this.stringToLines(),this.cacheRendering(),engine.enableRedrawRegions&&this.onAfterChange(),t)}}),Object.defineProperty(this,"alignment",{get:function(){return s.alignment},set:function(t){if(-1===["left","center","right"].indexOf(t))throw new Error("alignment should be one of the following: ALIGNMENT_LEFT, ALIGNMENT_CENTER, ALIGNMENT_RIGHT");return t===s.alignment?t:(s.alignment=t,this.cacheRendering(),engine.enableRedrawRegions&&this.onAfterChange(),t)}}),Object.defineProperty(this,"color",{get:function(){return s.color},set:function(t){if(!/#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})/.test(t))throw new Error("color should be a CSS color string");return t===s.color?t:(s.color=t,this.cacheRendering(),engine.enableRedrawRegions&&this.onAfterChange(),t)}}),Object.defineProperty(this,"lineHeight",{get:function(){return s.lineHeight},set:function(t){return s.lineHeight="number"!=typeof t?t:parseFloat(t),this.calculateCanvasHeight(),this.cacheRendering(),engine.enableRedrawRegions&&this.onAfterChange(),t}}),Object.defineProperty(this,"width",{get:function(){return Math.abs(this.clipWidth*this.size*this.widthScale)},set:function(t){var e;return e=this.widthScale>0?1:-1,this.widthScale=e*Math.abs(t/(this.clipWidth*this.size)),t}}),Object.defineProperty(this,"height",{get:function(){return Math.abs(this.clipHeight*this.size*this.heightScale)},set:function(t){var e;return e=this.heightScale>0?1:-1,this.heightScale=e*Math.abs(t/(this.clipHeight*this.size)),t}}),this.lineHeight=r&&r.lineHeight?r.lineHeight:1.25*this.font.match(/[0.0-9]+/),a=OFFSET_TOP_LEFT,r&&r.offset&&(a=r.offset,delete r.offset),this["import"](r),this.string=t,this.offset=a,engine.avoidSubPixelRendering&&(this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y))}return __extends(e,t),Object.prototype["import"].call(e.prototype,Mixin.Animatable),e.prototype.parseOffsetGlobal=function(t){var e;return e=new Math.Vector,-1!==[OFFSET_TOP_LEFT,OFFSET_MIDDLE_LEFT,OFFSET_BOTTOM_LEFT].indexOf(t)?e.x=0:-1!==[OFFSET_TOP_CENTER,OFFSET_MIDDLE_CENTER,OFFSET_BOTTOM_CENTER].indexOf(t)?e.x=this.clipWidth/2:-1!==[OFFSET_TOP_RIGHT,OFFSET_MIDDLE_RIGHT,OFFSET_BOTTOM_RIGHT].indexOf(t)&&(e.x=this.clipWidth),-1!==[OFFSET_TOP_LEFT,OFFSET_TOP_CENTER,OFFSET_TOP_RIGHT].indexOf(t)?e.y=0:-1!==[OFFSET_MIDDLE_LEFT,OFFSET_MIDDLE_CENTER,OFFSET_MIDDLE_RIGHT].indexOf(t)?e.y=this.clipHeight/2:-1!==[OFFSET_BOTTOM_LEFT,OFFSET_BOTTOM_CENTER,OFFSET_BOTTOM_RIGHT].indexOf(t)&&(e.y=this.clipHeight),e},e.prototype.stringToLines=function(){var t,e,i,o,n,r,s;for(e=void 0,t=void 0,i=void 0,o=void 0,s=void 0,n=void 0,r=void 0,e=document.createElement("span"),e.style.font=this.font,e.style.visibility="hidden",e.style.position="absolute",document.body.appendChild(e),t=0,this.lines=[],this.lines[t]="",i=this.string.split("\n"),o=0;o<i.length;){for(s=i[o].split(" "),e.innerHTML="",this.lines[t]="",n=0;n<s.length;)r=s[n],e.innerHTML+=r+" ",e.offsetWidth>this.clipWidth?(t++,this.lines[t]="",e.innerHTML="",e.innerHTML+=r+" ",this.lineWidth[t]=e.offsetWidth):this.lineWidth[t]=e.offsetWidth,this.lines[t]+=r+" ",n++;t++,o++}this.calculateCanvasHeight(),e.parentNode.removeChild(e)},e.prototype.calculateCanvasHeight=function(){this.bm.height=(this.lines.length-1)*this.lineHeight+1.25*this.font.match(/[0.0-9]+/),this.clipHeight=this.bm.height},e.prototype.cacheRendering=function(){var t,e;for(e=void 0,t=void 0,this.bmCtx.clearRect(0,0,this.bm.width,this.bm.height),this.bmCtx.font=this.font,this.bmCtx.fillStyle=this.color,t=0;t<this.lines.length;){switch(e=0,this.alignment){case"left":e=0;break;case"right":e=this.clipWidth-this.lineWidth[t];break;case"center":e=(this.clipWidth-this.lineWidth[t])/2}this.lines[t]&&this.bmCtx.fillText(this.lines[t],e,this.lineHeight*t+1*this.font.match(/[0.0-9]+/)),t++}this.createHash()},e.prototype.createHash=function(){var t;t=void 0,t=this,this.bm.oldSrc=this.bm.src,this.bm.src=["string","font","alignment","color","lineHeight","clipWidth"].map(function(e){return t[e]}).join("-|-")},e.prototype.isVisible=function(){return!(0===this.size||0===this.widthScale||0===this.heightScale||/^\s*$/.test(this.string))},e.prototype.getRedrawRegion=function(){var t;return t=void 0,t=new Math.Rectangle(-this.offset.x,-this.offset.y,this.clipWidth,this.clipHeight),t=t.getPolygon(),t=t.scale(this.size*this.widthScale,this.size*this.heightScale),t=t.rotate(this.direction),t=t.getBoundingRectangle().add(this.getRoomPosition()),t.x=Math.floor(t.x-1),t.y=Math.floor(t.y-1),t.width=Math.ceil(t.width+2),t.height=Math.ceil(t.height+2),t},e}(View.Container);var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};nameSpace("View"),View.GameObject=function(t){function e(t,i,o,n,r){if(void 0===t)throw new Error("Missing argument: source");if(void 0===i)throw new Error("Missing argument: x");if(void 0===o)throw new Error("Missing argument: y");e.__super__.constructor.call(this,t,i,o,n,r),this.loop=this.loop?this.loop:engine.defaultActivityLoop,this.loop.attachFunction(this,this.updatePosition),this.speed=this.speed?this.speed:new Math.Vector(0,0),this.alive=!0}return __extends(e,t),e.prototype.updatePosition=function(){this.alive&&(this.x+=engine.convertSpeed(this.speed.x),this.y+=engine.convertSpeed(this.speed.y))
},e}(View.Collidable);var __hasProp={}.hasOwnProperty,__extends=function(t,e){function i(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return i.prototype=e.prototype,t.prototype=new i,t.__super__=e.prototype,t};nameSpace("Engine"),Engine.Room=function(t){function e(t,i,o){e.__super__.constructor.call(this),this.name=t?t:engine.roomList.length,this.onEntered=void 0!==i?i:function(){},this.onLeft=void 0!==o?o:function(){},this.loops={},this.paused=!1,this.addLoop("eachFrame",new Engine.CustomLoop),engine.addRoom(this)}return __extends(e,t),e.prototype.pause=function(){this.paused=!0},e.prototype.play=function(){this.paused=!1},e.prototype.update=function(){var t;if(!this.paused){t=void 0;for(t in this.loops)this.loops.hasOwnProperty(t)&&this.loops[t].execute()}},e.prototype.addLoop=function(t,e){if(void 0===e)throw new Error("Missing argument: loop");if(void 0===t)throw new Error("Missing argument: name");if(void 0!==this.loops[t])throw new Error("Name is taken: "+t);this.loops[t]=e},e.prototype.removeLoop=function(t){if(void 0===t)throw new Error("Missing argument: name");if("eachFrame"===t)throw new Error('The "eachFrame" loop cannot be removed');delete this.loops[t]},e.prototype.remove=void 0,e}(View.Container),nameSpace("Engine"),Engine.Camera=function(){function t(t,e,i){if(!t instanceof Math.Rectangle)throw new Error("Argument captureRegion should be of type: Rectangle");if(!e instanceof Math.Rectangle)throw new Error("Argument projectionRegion should be of type: Rectangle");this.captureRegion=t,this.projectionRegion=e,this.room=i||engine.currentRoom}return t}(),nameSpace("Engine"),Engine.CustomLoop=function(){function CustomLoop(t,e){this.framesPerExecution=void 0===t?1:t,this.maskFunction=void 0===e?function(){return!0}:e,this.functionsQueue=[],this.functions=[],this.executionsQueue=[],this.executions=[],this.animations=[],this.lastFrame=window.engine.frames,this.last=window.engine.now?window.engine.now:(new Date).getTime(),this.time=0,this.execTime=0}return CustomLoop.prototype.attachFunction=function(t,e){if(void 0===t)throw new Error("Missing argument: caller");if(void 0===e)throw new Error("Missing argument: func");if("function"!=typeof e)throw new Error("Argument func must be of type function");this.functionsQueue.push({object:t,activity:e})},CustomLoop.prototype.addFunctionsQueue=function(){this.functions=this.functions.concat(this.functionsQueue),this.functionsQueue=[]},CustomLoop.prototype.detachFunction=function(t,e){var i,o;if(void 0===t)throw new Error("Missing argument: caller");if(void 0===e)throw new Error("Missing argument: func");for(o=void 0,i=void 0,o=0;o<this.functions.length;){if(i=this.functions[o],i.object===t&&i.activity===e)return this.functions.splice(o,1),!0;o++}for(o=0;o<this.functionsQueue.length;){if(i=this.functionsQueue[o],i.object===t&&i.activity===e)return this.functionsQueue.splice(o,1),!0;o++}return!1},CustomLoop.prototype.detachFunctionsByFunction=function(t){var e,i;if(void 0===t)throw new Error("Missing argument: func");return i=void 0,e=void 0,i=[],e=this.functions.length,function(){var i;for(i=[];e--;)i.push(t===this.functions[e].func);return i}.call(this)&&i.push(this.functions.splice(e,1)),e=this.functionsQueue.length,function(){var i;for(i=[];e--;)i.push(t===this.functions[e].func);return i}.call(this)&&i.push(this.functionsQueue.splice(e,1)),i.length?i:!1},CustomLoop.prototype.detachFunctionsByCaller=function(t){var e,i;if(void 0===t)throw new Error("Missing argument: caller");return i=void 0,e=void 0,i=[],e=this.functions.length,function(){var i;for(i=[];e--;)i.push(t===this.functions[e].object);return i}.call(this)&&i.push(this.functions.splice(e,1)),e=this.functionsQueue.length,function(){var i;for(i=[];e--;)i.push(t===this.functionsQueue[e].object);return i}.call(this)&&i.push(this.functionsQueue.splice(e,1)),i.length?i:!1},CustomLoop.prototype.schedule=function(t,e,i){if(void 0===t)throw new Error("Missing argument: caller");if(void 0===e)throw new Error("Missing argument: function");if(void 0===i)throw new Error("Missing argument: delay");this.executionsQueue.push({func:e,execTime:this.time+i,caller:t})},CustomLoop.prototype.addExecutionsQueue=function(){this.executions=this.executions.concat(this.executionsQueue),this.executionsQueue=[]},CustomLoop.prototype.unschedule=function(t,e){var i,o;if(void 0===t)throw new Error("Missing argument: caller");if(void 0===e)throw new Error("Missing argument: function");for(o=void 0,i=void 0,o=0;o<this.executions.length;){if(i=this.executions[o],t===i.caller&&(i.func===e||i.func.toString()===e))return this.executions.splice(o,1),!0;o++}for(o=0;o<this.executionsQueue.length;){if(i=this.executionsQueue[o],t===i.caller&&(i.func===e||i.func.toString()===e))return this.executionsQueue.splice(o,1),!0;o++}return!1},CustomLoop.prototype.unscheduleByFunction=function(t){var e,i,o;if(void 0===t)throw new Error("Missing argument: func");for(o=void 0,i=void 0,e=void 0,o=[],i=this.executions.length;i--;)e=this.executions[i],t===e.func&&o.push(this.executions.splice(i,1));for(i=this.executionsQueue.length;i--;)e=this.executionsQueue[i],t===e.func&&o.push(this.executionsQueue.splice(i,1));return o.length?o:!1},CustomLoop.prototype.unscheduleByCaller=function(t){var e,i,o;if(void 0===t)throw new Error("Missing argument: caller");for(o=void 0,i=void 0,e=void 0,o=[],i=this.executions.length;i--;)e=this.executions[i],t===e.caller&&o.push(this.executions.splice(i,1));for(i=this.executionsQueue.length;i--;)e=this.executionsQueue[i],t===e.caller&&o.push(this.executionsQueue.splice(i,1));return o.length?o:!1},CustomLoop.prototype.unscheduleAll=function(){var t;return t=void 0,t=[].concat(this.executions,this.executionsQueue),this.executions=[],this.executionsQueue=[],t},CustomLoop.prototype.addAnimation=function(t){var e,i,o,n,r,s;if(void 0===t)throw new Error("Missing argument: animation");for(e=void 0,r=void 0,o=void 0,n=void 0,i=void 0,s=void 0,e=t,e.start=this.time,r=Object.keys(e.prop),o=e.obj.getAnimations(),n=0;n<o.length;){i=o[n];for(s in i.prop)i.prop.hasOwnProperty(s)&&-1!==r.indexOf(s)&&delete i.prop[s];n++}this.animations.push(e)},CustomLoop.prototype.removeAnimationsOfObject=function(t){var e;e=void 0,e=this.animations.length,function(){var i;for(i=[];e--;)i.push(t===this.animations[e].obj);return i}.call(this)&&this.animations.splice(e,1)},CustomLoop.prototype.updateAnimations=function(){var a,animId,propId,t;for(animId=void 0,a=void 0,propId=void 0,t=void 0,animId=this.animations.length-1;animId>-1;)if(a=this.animations[animId],void 0!==a){if(t=this.time-a.start,t>a.duration){this.animations.splice(animId,1);for(propId in a.prop)a.prop.hasOwnProperty(propId)&&(a.obj[propId]=a.prop[propId].end);"string"==typeof a.callback?eval(a.callback):a.callback.call(a.obj)}else for(propId in a.prop)a.prop.hasOwnProperty(propId)&&(a.obj[propId]=a.easing(t,a.prop[propId].begin,a.prop[propId].end-a.prop[propId].begin,a.duration));a.onStep&&a.onStep(),animId--}},CustomLoop.prototype.execute=function(){var t,e,i;if(i=void 0,e=void 0,t=void 0,i=(new Date).getTime(),this.maskFunction()&&!(engine.frames%this.framesPerExecution)){for(engine.frames-this.lastFrame===this.framesPerExecution&&(this.time+=engine.gameTimeIncrease),this.lastFrame=engine.frames,this.last=engine.now,this.updateAnimations(),e=this.executions.length;e--;)e>=this.executions.length||(t=this.executions[e],this.time>=t.execTime&&(t.func.call(t.caller),this.executions.splice(e,1)));for(e=0;e<this.functions.length;){if(t=this.functions[e],!t.activity)throw new Error("Trying to exec non-existent attached function");t.activity.call(t.object),e++}this.addFunctionsQueue(),this.addExecutionsQueue(),this.execTime=(new Date).getTime()-i}},CustomLoop}(),nameSpace("Input"),Input.Keyboard=function(){function t(){var t;for(t=void 0,document.addEventListener("keydown",function(t){return function(e){t.onKeyDown(e),engine.preventDefaultKeyboard&&e.preventDefault()}}(this),!1),document.addEventListener("keyup",function(t){return function(e){t.onKeyUp(e),engine.preventDefaultKeyboard&&e.preventDefault()}}(this),!1),this.keys=new Array(400),t=0;t<this.keys.length;)this.keys[t]={events:[]},t++}return t.prototype.onKeyDown=function(t){var e;if(e=void 0,void 0===t)throw new Error("Missing argument: event");this.isDown(t.keyCode)||(e=this.keys[t.keyCode],e.events=e.events.slice(0,1),e.events.unshift((new Date).getTime()))},t.prototype.onKeyUp=function(t){var e;if(e=void 0,void 0===t)throw new Error("Missing argument: event");this.isDown(t.keyCode)&&(e=this.keys[t.keyCode],e.events=e.events.slice(0,1),e.events.unshift(-(new Date).getTime()))},t.prototype.isDown=function(t){if(void 0===t)throw new Error("Missing argument: key");return"string"==typeof t&&(t=t.toUpperCase().charCodeAt(0)),this.keys[t].events.length&&this.keys[t].events[0]>0},t.prototype.isPressed=function(t){if(void 0===t)throw new Error("Missing argument: key");return"string"==typeof t&&(t=t.toUpperCase().charCodeAt(0)),this.keys[t].events.length&&this.keys[t].events[0]>engine.last},t.prototype.isReleased=function(t){if(void 0===t)throw new Error("Missing argument: key");return"string"==typeof t&&(t=t.toUpperCase().charCodeAt(0)),this.keys[t].events.length&&-this.keys[t].events[0]>engine.last},t}(),nameSpace("Input"),Input.Pointer=function(){function t(){var t;for(t=void 0,engine.host.hasTouch?(document.addEventListener("touchstart",function(t){return function(e){t.onTouchStart(e)}}(this),!1),document.addEventListener("touchend",function(t){return function(e){t.onTouchEnd(e)}}(this),!1),document.addEventListener("touchmove",function(t){return function(e){t.onTouchMove(e)}}(this),!1)):(document.addEventListener("mousedown",function(t){return function(e){t.onMouseDown(e)}}(this),!1),document.addEventListener("mouseup",function(t){return function(e){t.onMouseUp(e)}}(this),!1),document.addEventListener("mousemove",function(t){return function(e){engine.host.hasMouse=!0,t.onMouseMove(e)}}(this),!1)),this.mouse=new Math.Vector,this.mouse.window=new Math.Vector,this.mouse.buttons=new Array(11),t=0;t<this.mouse.buttons.length;)this.mouse.buttons[t]=new Math.Vector,this.mouse.buttons[t].events=new Array(2),t++;for(this.mouse.lastMoved=0,this.touches=new Array(10),t=0;t<this.touches.length;)this.touches[t]=new Math.Vector,this.touches[t].x=void 0,this.touches[t].y=void 0,this.touches[t].events=new Array(2),t++}return t.prototype.onMouseDown=function(t){var e;if(void 0===t)throw new Error("Missing argument: event");this.onMouseMove(t),this.isDown(t.which)||(e=this.mouse.buttons[t.which],e.events=e.events.slice(0,1),e.events.unshift((new Date).getTime()))},t.prototype.onMouseUp=function(t){var e;if(void 0===t)throw new Error("Missing argument: event");e=void 0,this.onMouseMove(t),this.isDown(t.which)&&(e=this.mouse.buttons[t.which],e.events=e.events.slice(0,1),e.events.unshift(-(new Date).getTime()))},t.prototype.onMouseMove=function(t){var e;if(void 0===t)throw new Error("Missing argument: event");e=void 0,this.mouse.window.set(t.pageX,t.pageY),this.mouse.set(this.mouse.window.x-engine.arena.offsetLeft-engine.canvas.offsetLeft+document.body.scrollLeft,this.mouse.window.y-engine.arena.offsetTop-engine.canvas.offsetTop+document.body.scrollTop),this.mouse.x=this.mouse.x/engine.arena.offsetWidth*engine.canvasResX,this.mouse.y=this.mouse.y/engine.arena.offsetHeight*engine.canvasResY,e=this.calculateRoomPosition(this.mouse),this.mouse.x=e.x,this.mouse.y=e.y,this.mouse.buttons.forEach(function(t){return function(e){e.x=t.mouse.x,e.y=t.mouse.y}}(this)),this.mouse.lastMoved=(new Date).getTime(),this.cursor&&(this.cursor.x=this.mouse.x,this.cursor.y=this.mouse.y)},t.prototype.onTouchStart=function(t){var e,i,o,n,r,s;if(void 0===t)throw new Error("Missing argument: event");for(s=t.changedTouches,n=0,r=s.length;r>n;n++)e=s[n],o=this.findTouchNumber(),i=this.touches[o],i.identifier=e.identifier,i.events=i.events.slice(0,1),i.events.unshift((new Date).getTime());this.onTouchMove(t)},t.prototype.onTouchEnd=function(t){var e,i,o,n,r;if(void 0===t)throw new Error("Missing argument: event");for(r=t.changedTouches,o=0,n=r.length;n>o;o++)e=r[o],i=this.touches.filter(function(t){return t.identifier===e.identifier})[0],i.events=i.events.slice(0,1),i.events.unshift(-(new Date).getTime());this.onTouchMove(t)},t.prototype.onTouchMove=function(t){var e,i,o,n,r,s;if(void 0===t)throw new Error("Missing argument: event");for(s=t.touches,n=0,r=s.length;r>n;n++)e=s[n],i=this.touches.filter(function(t){return t.identifier===e.identifier})[0],i.set(e.pageX-engine.arena.offsetLeft-engine.canvas.offsetLeft+document.body.scrollLeft,e.pageY-engine.arena.offsetTop-engine.canvas.offsetTop+document.body.scrollTop),i.x=i.x/engine.arena.offsetWidth*engine.canvasResX,i.y=i.y/engine.arena.offsetHeight*engine.canvasResY,o=this.calculateRoomPosition(i),i.x=o.x,i.y=o.y},t.prototype.mouseHasMoved=function(){return engine.last<this.mouse.lastMoved},t.prototype.isDown=function(t){var e;if(void 0===t)throw new Error("Missing argument: button");switch(this.getButtonType(t)){case"mouse":e=t===MOUSE_ANY?this.mouse.buttons:this.mouse.buttons[t];break;case"touch":e=t===TOUCH_ANY?this.touches:this.touches[t-TOUCH_1];break;case"any":e=this.mouse.buttons.concat(this.touches)}return this.checkPointer(e,"down")},t.prototype.isPressed=function(t){var e;if(void 0===t)throw new Error("Missing argument: button");switch(e=void 0,this.getButtonType(t)){case"mouse":e=t===MOUSE_ANY?this.mouse.buttons:this.mouse.buttons[t];break;case"touch":e=t===TOUCH_ANY?this.touches:this.touches[t-TOUCH_1];break;case"any":e=this.mouse.buttons.concat(this.touches)}return this.checkPointer(e,"pressed")},t.prototype.isReleased=function(t){var e;if(void 0===t)throw new Error("Missing argument: button");switch(e=void 0,this.getButtonType(t)){case"mouse":e=t===MOUSE_ANY?this.mouse.buttons:this.mouse.buttons[t];break;case"touch":e=t===TOUCH_ANY?this.touches:this.touches[t-TOUCH_1];break;case"any":e=this.mouse.buttons.concat(this.touches)}return this.checkPointer(e,"released")},t.prototype.shapeIsPressed=function(t,e,i){var o,n,r,s,a,h;if(t=void 0!==t?t:MOUSE_TOUCH_ANY,void 0===e)throw new Error("Missing argument: shape");if("function"!=typeof e.contains)throw new Error('Argument shape has implement a "contains"-function');for(o=void 0,r=void 0,n=void 0,s=void 0,r=this.isPressed(t),s=[],a=0,h=r.length;h>a;a++)n=r[a],n.x!==!1&&n.y!==!1&&(!i&&e.contains(n)?s.push(n):i&&!e.contains(n)&&s.push(n));return s},t.prototype.shapeIsReleased=function(t,e,i){var o,n,r,s,a;if(t=void 0!==t?t:MOUSE_TOUCH_ANY,void 0===e)throw new Error("Missing argument: shape");if("function"!=typeof e.contains)throw new Error('Argument shape has implement a "contains"-function');for(n=this.isReleased(t),r=[],s=0,a=n.length;a>s;s++)o=n[s],o.x!==!1&&o.y!==!1&&(!i&&e.contains(o)?r.push(o):i&&!e.contains(o)&&r.push(o));return r},t.prototype.shapeIsDown=function(t,e,i){var o,n,r,s,a;if(t=void 0!==t?t:MOUSE_TOUCH_ANY,void 0===e)throw new Error("Missing argument: shape");if("function"!=typeof e.contains)throw new Error('Argument shape has implement a "contains"-function');for(n=this.isDown(t),r=[],s=0,a=n.length;a>s;s++)o=n[s],o.x!==!1&&o.y!==!1&&(!i&&e.contains(o)?r.push(o):i&&!e.contains(o)&&r.push(o));return r},t.prototype.getButtonType=function(t){if(t>=MOUSE_ANY&&MOUSE_10>=t)return"mouse";if(t>=TOUCH_ANY&&TOUCH_10>=t)return"touch";if(t===MOUSE_TOUCH_ANY)return"any";throw new Error("Argument button has to be a pointer constant (see jseGlobals.js)")},t.prototype.checkPointer=function(t,e){var i,o,n,r;if("undefined"===t)throw new Error("Missing argument: pointers");if("undefined"===e)throw new Error("Missing argument: state");if(-1===["pressed","released","down"].indexOf(e))throw new Error('Argument state must be one of the following values: "pressed", "released" or "down"');for(Array.prototype.isPrototypeOf(t)||(t=[t]),o=[],n=0,r=t.length;r>n;n++)switch(i=t[n],e){case"pressed":(i.events[0]>engine.last||i.events[1]>engine.last)&&o.push(i);break;case"released":(-i.events[0]>engine.last||-i.events[1]>engine.last)&&o.push(i);break;case"down":i.events[0]>0&&o.push(i)}return o},t.prototype.calculateRoomPosition=function(t){var e,i,o;for(o=void 0,i=void 0,e=void 0,o=t.copy(),i=engine.cameras.length;i--;)if(e=engine.cameras[i],e.projectionRegion.contains(t)||0===i)return o.subtract(e.projectionRegion),o.x*=e.captureRegion.width/e.projectionRegion.width,o.y*=e.captureRegion.height/e.projectionRegion.height,o.add(e.captureRegion),o;return o},t.prototype.findTouchNumber=function(){var t,e,i,o,n;for(n=this.touches,t=i=0,o=n.length;o>i;t=++i)if(e=n[t],!(e.events[0]>0))return t;return!1},t.prototype.shapeIsHovered=function(t,e){return!e&&t.contains(this.mouse)?!0:e&&!t.contains(this.mouse)?!0:!1},t.prototype.release=function(t){var e,i,o,n;if(void 0===t)throw new Error("Missing argument: button");if(i=void 0,o=void 0,e=void 0,n=void 0,o=this.isPressed(t),!o)return!1;for(i=0;i<o.length;)e=o[i].events,e[0]>engine.last&&(e.shift(),e.push(void 0),n=!0),e[1]>engine.last&&(e.pop(),e.push(void 0),n=!0),i++;return n},t.prototype.outside=function(){return new Math.Rectangle(engine.arena.offsetLeft,engine.arena.offsetTop,engine.arena.offsetWidth,engine.arena.offsetHeight).contains(this.mouse.window)===!1},t.prototype.resetCursor=function(){engine.arena.style.cursor="default"},t.prototype.setCursor=function(t){var e;if(void 0===t)throw new Error("Missing argument: cursor");if("string"!=typeof t)throw new Error("Argument cursor should be of type: string");e=void 0,e=loader.getImage(t),e?t="url('"+e.src+"') 0 0, auto":/^\w*$/.test(t)||(t="url('"+t+"') 0 0, auto"),engine.arena.style.cursor=t},t}(),nameSpace("Sound"),Sound.Effect=function(){function t(t){if(void 0===t)throw new Error("Missing argument: audioElement");if("[object HTMLAudioElement]"!==t.toString())throw new Error("Argument audioElement has to be of type HTMLAudioElement");this.source=t,this.playbackId=0,this.elements=[],this.source.addEventListener("canplaythrough",function(t){return function(){t.cacheCopies()}}(this),!1)}return t.prototype.cacheCopies=function(){var t,e;for(t=0,e=[];t<engine.cachedSoundCopies;)this.elements.push(this.source.cloneNode()),this.elements[t].started=!1,e.push(t++);return e},t.prototype.play=function(t){var e,i,o,n;if(engine.soundsMuted)return!1;for(n=this.elements,i=0,o=n.length;o>i;i++)if(e=n[i],(e.started===!1||e.ended)&&!e.loop)return e.started=!0,e.volume=1,e.play(),t&&(e.loop="loop"),this.playbackId++,e.playbackId=this.playbackId,this.playbackId;return!1},t.prototype.stop=function(t){var e,i,o,n;if(void 0===t)throw new Error("Missing argument: playbackId");for(n=this.elements,i=0,o=n.length;o>i;i++)if(e=n[i],e.playbackId===t&&e.started&&!e.ended)return e.volume=0,e.loop=!1,!0;return!1},t.prototype.stopAll=function(){var t,e,i,o;for(o=this.elements,e=0,i=o.length;i>e;e++)t=o[e],t.started&&!t.ended&&(t.volume=0,t.loop=!1)},t.prototype.stopLoop=function(t){var e;throw new Error("Missing argument: playbackId")(function(){var i,o,n;if(void 0===t){for(n=this.elements,i=0,o=n.length;o>i;i++)e=n[i],e.playbackId===t&&e.started&&!e.ended&&(e.loop=!1);return!1}}.call(this))},t}(),nameSpace("Sound"),Sound.Music=function(){function t(t){if(void 0===t)throw new Error("Missing argument: audioElement");if("[object HTMLAudioElement]"!==t.toString())throw new Error("Argument audioElement has to be of type HTMLAudioElement");this.source=t,this.paused=!1}return t.prototype.play=function(t){return engine.musicMuted?!1:(this.source.play(),this.paused=!1,t&&(this.source.loop="loop"),!0)},t.prototype.pause=function(){this.paused=!0,this.source.pause()},t.prototype.stop=function(){return this.source.ended?!1:(this.source.pause(),this.source.currentTime=0,this.source.loop=!1,!0)},t.prototype.stopLoop=function(){return this.source.started&&!this.source.ended?(this.source.loop=!1,!0):!1},t}();